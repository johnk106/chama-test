{%load static%}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Link Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="{%static 'chamas/style.css'%}" />
  <link rel="stylesheet" href="{%static 'chamas/brand-colors.css'%}" />

  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <!-- Header dependencies from goals dashboard -->
  <link rel="stylesheet" href="{% static 'css/simplebar.css' %}">
  <link rel="stylesheet" href="{% static 'css/feather.css' %}">
  <link rel="stylesheet" href="{% static 'css/app-light.css' %}" id="lightTheme">
  <link rel="stylesheet" href="{% static 'css/app-dark.css' %}" id="darkTheme">
  <link rel="stylesheet" href="{% static 'chamas/header-override.css' %}">
  <style>
    .profile {
      display: flex;
      align-items: center;
    }

    .dropdown {
      position: relative;
    }

    .dropdown-toggle {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: #333;
      /* Adjust color as needed */
      cursor: pointer;
    }

    .dropdown-toggle img {
      margin-right: 5px;
      /* Adjust spacing as needed */
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: #fff;
      /* Adjust background color as needed */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      /* Adjust box-shadow as needed */
      padding: 10px;
      list-style: none;
      margin: 0;
    }

    .dropdown-menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .dropdown-menu li {
      padding: 5px 0;
    }

    /* Show dropdown when .show class is present */
    .dropdown-menu.show {
      display: block;
    }


    .iframe-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); 
      justify-content: center;
      align-items: center;
  }
  .iframe-container iframe {
      width: 80%;
      height: 80%;
      filter: blur(10px);
      border: none;
      background: white;
  }
  .iframe-container.show {
      display: flex;
  }
  .close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      border: none;
      font-size: 20px;
      cursor: pointer;
  }
  </style>


  {%block head%}
  <title>Chamaspace</title>
  {%endblock%}
</head>
  <body class="vertical light">
    <!-- Main Layout Container -->
    <div class="app-layout">
    
    <!-- Mobile Sidebar (Hidden by default, shown on mobile when menu is clicked) -->
    <div id="mySidenav" class="sidenav">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
      <div class="logo_details">
        <img src="{%static 'chamas/logo.png'%}" alt="Logo" />
      </div>
      <ul class="nav-list">
        <li>
          <a href="#" class="dashboard-link">
            <i class='bx bx-bolt-circle'></i>
            <span class="link_name">Dashboard</span>
          </a>
        </li>
        <li>
          <a href="#" class="finances-link">
            <i class="bx bx-wallet"></i>
            <span class="link_name">Finances Page</span>
          </a>
        </li>
        <li>
          <a class="contribution-link" href="#">
            <i class='bx bx-sort bx-rotate-90'></i>
            <span class="link_name">Contributions</span>
          </a>
        </li>
        <li>
          <a href="#" class="loans-link">
            <i class='bx bxs-donate-heart'></i>
            <span class="link_name">Loans</span>
          </a>
        </li>
        <li>
          <a href="#" class="expenses-link">
            <i class="bx bx-folder"></i>
            <span class="link_name">Expenses</span>
          </a>
        </li>
        <li>
          <a href="#" class="fines-link">
            <i class="bx bx-file"></i>
            <span class="link_name">Fines</span>
          </a>
        </li>
        <li>
          <a href="#" class="reports-link">
            <i class='bx bxs-report'></i>
            <span class="link_name">Reports</span>
          </a>
        </li>
        <li>
          <a href="#" class="members-link">
            <i class="bx bx-user"></i>
            <span class="link_name">Members</span>
          </a>
        </li>
        <li>
          <a href="#" class="notifications-link">
            <i class="bx bx-bell"></i>
            <span class="link_name">Notifications</span>
          </a>
        </li>
        <li class="admin">
          <a href="#" class="bot-link">
            <i class="bx bx-cog"></i>
            <span class="link_name">Bot Control</span>
          </a>
        </li>
        <li>
          <a href="{%url 'chamas:chamas'%}">
            <i class="bx bx-arrow-back"></i>
            <span class="link_name">Back</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- Desktop Sidebar (Always visible on desktop) -->
    <aside class="desktop-sidebar">
      <div class="sidebar-header">
        <div class="logo_details">
          <img src="{%static 'chamas/logo.png'%}" alt="Logo" />
        </div>
      </div>
      <nav class="sidebar-nav">
        <ul class="nav-list">
          <li>
            <a href="#" class="dashboard-link">
              <i class='bx bx-bolt-circle'></i>
              <span class="link_name">Dashboard</span>
            </a>
          </li>
          <li>
            <a href="#" class="finances-link">
              <i class="bx bx-wallet"></i>
              <span class="link_name">Finances Page</span>
            </a>
          </li>
          <li>
            <a class="contribution-link" href="#">
              <i class='bx bx-sort bx-rotate-90'></i>
              <span class="link_name">Contributions</span>
            </a>
          </li>
          <li>
            <a href="#" class="loans-link">
              <i class='bx bxs-donate-heart'></i>
              <span class="link_name">Loans</span>
            </a>
          </li>
          <li>
            <a href="#" class="expenses-link">
              <i class="bx bx-folder"></i>
              <span class="link_name">Expenses</span>
            </a>
          </li>
          <li>
            <a href="#" class="fines-link">
              <i class="bx bx-file"></i>
              <span class="link_name">Fines</span>
            </a>
          </li>
          <li>
            <a href="#" class="reports-link">
              <i class='bx bxs-report'></i>
              <span class="link_name">Reports</span>
            </a>
          </li>
          <li>
            <a href="#" class="members-link">
              <i class="bx bx-user"></i>
              <span class="link_name">Members</span>
            </a>
          </li>
          <li>
            <a href="#" class="notifications-link">
              <i class="bx bx-bell"></i>
              <span class="link_name">Notifications</span>
            </a>
          </li>
          <li class="admin">
            <a href="#" class="bot-link">
              <i class="bx bx-cog"></i>
              <span class="link_name">Bot Control</span>
            </a>
          </li>
          <li>
            <a href="{%url 'chamas:chamas'%}">
              <i class="bx bx-arrow-back"></i>
              <span class="link_name">Back</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>

         <!-- Global Dashboard Header (PC) -->
      {% include 'shared/goals_header_nav.html' %}

      <!-- Global Dashboard Sidenav (PC) -->
      {% include 'shared/dashboard_sidenav.html' %}

      <!-- Main Content Area -->
      <main class="main-content">
              {% include 'shared/goals_mobile_header.html' %}
             <!-- Mobile Header: replaced by shared include above -->

             <!-- Desktop Header: replaced by shared include above -->

                           {% include 'shared/chamas_subheader.html' %}

       <!-- Page Content -->
       <div class="page-content">
         {%block body%}
         {%endblock%}
       </div>
    </main>
  </div>

  <!-- Mobile Overlay -->
  <div class="mobile-overlay" onclick="closeNav()"></div>

  <!-- modals  -->

  <!-- add member to group modal-->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel" style="color: #2291A5;">Add Member to group</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="add-member-form">
            <h6 class="text"></h6>
            <div class="modal-alert-hub">

            </div>
            <form action="" id="add-member-form">
              {% csrf_token %}
              <div class="mb-3">
                <label for="Name" class="form-label" style="color: #2291A5;">Name</label>
                <input type="text" name="name" class="form-control" id="member-name" placeholder="member name..." required>
              </div>
              <div class="mb-3">
                <label for="email" class="form-label" style="color: #2291A5;">Email address</label>
                <input type="email" name="email" class="form-control" id="member-email" placeholder="name@example.com" required>
              </div>
              <div class="mb-3">
                <label for="id_number" class="form-label" style="color: #2291A5;">Id Number</label>
                <input type="number" name="id_number" class="form-control" id="member-id_number" placeholder="12345678" required>
              </div>
              <div class="mb-3">
                <label for="mobile" class="form-label" style="color: #2291A5;">Mobile</label>
                <input type="number" name="mobile" class="form-control" id="member-mobile" placeholder="07 xxx xxx" required>
              </div>
              <div class="input-group mb-3">
                <label class="input-group-text" for="inputGroupSelect01" style="color: #2291A5;">Role</label>
                <select class="form-select text-capitalize" name="role" id="member-role">
                  {%for role in roles%}
                  <option value="{{role.name}}">{{role.name}}</option>
                  {%endfor%}
                </select>
              </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button id="add-member-modal-button" type="button" class="btn btn-primary" style="background-color: #2291A5;">Save changes</button>

        </div>
        </form>

      </div>
    </div>
  </div>

  <!--end modal-->



  <div class="iframe-container" id="iframeContainer">
    <button class="close-button" id="closeIframe">X</button>
    <iframe src="/subscriptions/plans/" id="iframe"></iframe>
  </div>




  <script src="{%static 'chamas/script.js'%}"></script>
  <script src="https://kit.fontawesome.com/d90233e428.js" crossorigin="anonymous"></script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
  <!-- Add this script tag at the end of your HTML body section -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <script src="{% static 'js/popper.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
  <script src="{% static 'js/simplebar.min.js' %}"></script>
  <script src="{% static 'js/config.js' %}"></script>
  <script src="{% static 'js/apps.js' %}"></script>
  <script>
    /* Open mobile navigation */
    function openNav() {
      document.getElementById("mySidenav").style.width = "260px";
      document.querySelector(".mobile-overlay").style.display = "block";
      document.querySelector(".mobile-overlay").classList.add("show");
    }

    /* Close mobile navigation */
    function closeNav() {
      document.getElementById("mySidenav").style.width = "0";
      document.querySelector(".mobile-overlay").style.display = "none";
      document.querySelector(".mobile-overlay").classList.remove("show");
    }

  function getGroupId() {
    return localStorage.getItem('groupId');
  }


    $(document).ready(function () {
      function handleDashboardClick (){
        var chama_id = getGroupId();

        if (chama_id){
          window.location.href = `/chamas-bookeeping/chama-dashboard/${chama_id}/`;
        }else{
          console.error('invalid chama_id');
        }
      }

      function handleContributionsClick() {
        var chama_id = getGroupId();

        if (chama_id) {
          window.location.href = `/chamas-bookeeping/contributions/${chama_id}/`;
        } else {
          console.error('Invalid chama_id');
        }
      }

      function handleMembersClick() {
        var chama_id = getGroupId();

        if (chama_id) {
          window.location.href = `/chamas-bookeeping/members/${chama_id}/`
        } else {
          console.log('invalid chama id');
        }
      }

      function handleFinesClick() {
        var chama_id = getGroupId();

        if (chama_id) {
          window.location.href = `/chamas-bookeeping/chama-fines/${chama_id}/`
        } else {
          console.log('invalid chama id');
        }
      }

      function handleLoansClick() {
        var chama_id = getGroupId();

        if (chama_id) {
          window.location.href = `/chamas-bookeeping/chama-loans/${chama_id}/`;

        } else {
          console.log('invalid chama id');
        }
      }

      function handleExpensesClick() {
        var chama_id = getGroupId();

        if (chama_id) {
          window.location.href = `/chamas-bookeeping/chama-expenses/${chama_id}/`;
        } else {
          console.log('invalid chama id');
        }
      }

      function handleFinancesClick() {
        var chama_id = getGroupId();

        if (chama_id) {
          window.location.href = `/chamas-bookeeping/chama-finances/${chama_id}/`;
        } else {
          console.log('invalid chama id');
        }
      }

      function handleReportsClick() {
        var chama_id = getGroupId();

        if (chama_id) {
          window.location.href = `/chamas-bookeeping/chama-reports/${chama_id}/`;
        } else {
          console.log('invalid chama id');
        }
      }

      function handleNotificationsClick() {
        var chama_id = getGroupId();

        if (chama_id) {
          window.location.href = `/chamas-bookeeping/chama-notifications/${chama_id}/`;
        } else {
          console.log('Invalid chama id');
        }
      }

      function handleBotClick() {
        var chama_id = getGroupId();

        if(chama_id) {
          window.location.href = `/bot/reports/${chama_id}/`;
        }else{
          console.log('Invalid chama id');
        }
      }

      // Attach the click event handlers to  links
      $('.dashboard-link').on('click', function (event) {
        event.preventDefault();
        handleDashboardClick();
      });

      $('.contribution-link').on('click', function (event) {
        event.preventDefault();
        handleContributionsClick();
      });

    $('.members-link').on('click',function(event){
      event.preventDefault();
      handleMembersClick();
    });

    $('.loans-link').on('click',function(event){
      event.preventDefault();
      handleLoansClick();
    });

    $('.fines-link').on('click',function(event){
      event.preventDefault();
      handleFinesClick();
    });

    $('.expenses-link').on('click',function(event){
      event.preventDefault();
      handleExpensesClick();
    });

    $('.finances-link').on('click',function(event){
      event.preventDefault();
      handleFinancesClick();
    });

    $('.reports-link').on('click',function(event){
      event.preventDefault();
      handleReportsClick();
    });

    $('.notifications-link').on('click',function(event){
      event.preventDefault();
      handleNotificationsClick();
    })

    $('.bot-link').on('click',function(event){
      event.preventDefault();
      handleBotClick();
    })

  


  });

    
  {% comment %} ('#diamond').on('click',function(event){
    event.preventDefault();
    handleDiamondClick();
  }) {% endcomment %}

  function handleDiamondClick (){
    var chama_id = getGroupId();

    if (chama_id){
      window.location.href = `/subscriptions/plans/${chama_id}`;
    }else{
      console.error('invalid chama_id');
    }
  }

</script>
<!-- Populate the dropdown menu with profile options -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Function to toggle the dropdown
    function toggleDropdown() {
      var dropdown = document.querySelector('.profile .dropdown-menu');
      dropdown?.classList.toggle('show');
    }

    // Attach click event to the profile dropdown
    document.querySelector('.profile .dropdown-toggle')?.addEventListener('click', function (event) {
      event.preventDefault();
      event.stopPropagation();
      toggleDropdown();
    });

    // Close the dropdown when clicking outside of it
    //document.addEventListener('click', function (event) {
    //  var dropdown = document.querySelector('.profile .dropdown-menu');
    //  if (dropdown?.classList.contains('show') && !dropdown?.contains(event.target)) {
    //    toggleDropdown();
    //  }
    //});
  });
</script>


{% comment %} <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> {% endcomment %}
<script>
$(document).ready(function() {
  // 1) Grab groupId and localStorage key
  var groupId = localStorage.getItem('groupId');
  if (!groupId) {
    console.error("No groupId in localStorage!");
    return;
  }
  var storageKey = "selectedView_" + groupId;
  var savedView = localStorage.getItem(storageKey) || "member";

  // 2) IMMEDIATELY hide all admin‐only elements on page load
  //    (so that nothing flashes on the screen before AJAX finishes)
  $(".admin, #remove-user, #add-member-button").hide();
  
  // 2.1) IMMEDIATELY disable the view switch for all users until verified
  $("#viewToggle, #viewToggleDesktop").prop('disabled', true);

  // 3) Initialize the switch state based on savedView
  if (savedView === "member") {
    // If last‐saved was member, set switch to member position
    $("#viewToggle, #viewToggleDesktop").prop('checked', false);
    $(".switch-label-member").show();
    $(".switch-label-admin").hide();
  } else {
    // savedView is "admin" (user clicked admin on a previous page).
    // Set switch to admin position but keep disabled until verified
    $("#viewToggle, #viewToggleDesktop").prop('checked', true);
    $(".switch-label-member").hide();
    $(".switch-label-admin").show();
  }

  // 4) Now call the server to see "am I admin in this group?"
  $.ajax({
    url: '/chamas-bookeeping/get_user_role/',
    data: { group_id: groupId },
    dataType: 'json',
    success: function(data) {
      // If the server says I'm not an admin here or there's an error:
      if (data.role !== "admin" || data.error) {
        // Force member mode, keep switch disabled
        savedView = "member";
        $("#viewToggle, #viewToggleDesktop").prop('checked', false).prop('disabled', true);
        // Re‐apply member‐only UI
        updateView("member");
        // Overwrite localStorage in case it was "admin" before
        localStorage.setItem(storageKey, "member");
        
        // Log any errors for debugging
        if (data.error) {
          console.log("Role verification error:", data.error);
        }
      } else {
        // I am admin. Enable the switch now
        $("#viewToggle, #viewToggleDesktop").prop('disabled', false);

        // If they had last‐saved "admin," now we can safely flip on admin features:
        if (savedView === "admin") {
          updateView("admin");
          $("#viewToggle, #viewToggleDesktop").prop('checked', true);
          $(".switch-label-member").hide();
          $(".switch-label-admin").show();
        } else {
          // They last‐saved "member," so keep member view
          updateView("member");
          $("#viewToggle, #viewToggleDesktop").prop('checked', false);
          $(".switch-label-member").show();
          $(".switch-label-admin").hide();
        }
      }
    },
    error: function() {
      // If the AJAX fails, disable switch and stay in member view.
      $("#viewToggle, #viewToggleDesktop").prop('checked', false).prop('disabled', true);
      updateView("member");
      localStorage.setItem(storageKey, "member");
    }
  });

  // 5) Switch handler: whenever they toggle the switch, re‐verify if necessary
  $("#viewToggle, #viewToggleDesktop").on("change", function() {
    var isAdminView = $(this).is(':checked');

    if (isAdminView) {
      // If they toggle to admin, do one more AJAX check:
      $.ajax({
        url: '/chamas-bookeeping/get_user_role/',
        data: { group_id: groupId },
        dataType: 'json',
        success: function(data) {
          if (data.role === "admin") {
            // OK, they really are an admin: flip on admin mode
            updateView("admin");
            $("#viewToggle, #viewToggleDesktop").prop('checked', true);
            $(".switch-label-member").hide();
            $(".switch-label-admin").show();
            localStorage.setItem(storageKey, "admin");
          } else {
            // Not an admin—show alert and revert to member
            alert("You don't have admin permissions");
            updateView("member");
            $("#viewToggle, #viewToggleDesktop").prop('checked', false);
            $(".switch-label-member").show();
            $(".switch-label-admin").hide();
            localStorage.setItem(storageKey, "member");
          }
        },
        error: function() {
          // If AJAX fails, revert to member mode
          alert("Unable to verify permissions");
          updateView("member");
          $("#viewToggle, #viewToggleDesktop").prop('checked', false);
          $(".switch-label-member").show();
          $(".switch-label-admin").hide();
          localStorage.setItem(storageKey, "member");
        }
      });

    } else {
      // They toggled to member—just switch immediately (no need to re‐verify)
      updateView("member");
      $("#viewToggle, #viewToggleDesktop").prop('checked', false);
      $(".switch-label-member").show();
      $(".switch-label-admin").hide();
      localStorage.setItem(storageKey, "member");
    }
  });

  // 7) show/hide logic for each view
  function updateView(view) {
    if (view === "member") {
      // Remove admin class from body/html and hide admin elements
      $("body, html").removeClass("user-is-admin");
      $(".admin, #remove-user, #add-member-button").hide();
      $(".member").show();
    } else {
      // Add admin class to body/html and show admin elements
      $("body, html").addClass("user-is-admin");
      $(".member").hide();
      $(".admin, #remove-user, #add-member-button").show();
    }
  }
  
  // 8) Global function for pages to sync their visibility with current view state
  window.syncAdminVisibility = function() {
    var groupId = localStorage.getItem('groupId');
    if (!groupId) return;
    
    var storageKey = "selectedView_" + groupId;
    var currentView = localStorage.getItem(storageKey) || "member";
    
    // Apply the same logic as updateView but just for admin/member elements
    if (currentView === "member") {
      $("body, html").removeClass("user-is-admin");
      $(".admin, #remove-user, #add-member-button").hide();
      $(".member").show();
    } else {
      $("body, html").addClass("user-is-admin");
      $(".member").hide();
      $(".admin, #remove-user, #add-member-button").show();
    }
  };
});
</script>




<script>
 document.getElementById('add-member-modal-button').addEventListener('click', function() {
    // Collect form data
    const name = document.querySelector("input[name='name']").value;
    const role = document.querySelector("select[name='role']").value;
    const email = document.querySelector("input[name='email']").value;
    const phone = document.querySelector("input[name='mobile']").value;
    const id_number = document.querySelector("input[name='id_number']").value;
    var group = localStorage.getItem('groupId'); // Get group ID from localStorage

    // Create FormData object to send form data
    var formData = {
      name:name,
      role:role,
      email:email,
      phone:phone,
      id_number:id_number,
      group:group
    }
    console.log(formData)

    // Send fetch request
    fetch('/chamas-bookeeping/add-member/', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': "{{ csrf_token }}"
        },
        body: JSON.stringify(formData)
    })
    .then(function(response) {
        // Check if request was successful
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(function(data) {
                throw new Error(data.message);
            });
        }
    })
    .then(function(responseData) {
        // Success response
        var status = responseData.status;
        var message = responseData.message;

        // Display message in the alerts hub
        var alertsHub = document.querySelector('.modal-alert-hub');
        alertsHub.innerHTML = '<div class="alert alert-success" role="alert">' + message + '</div>';

        // Clear the form
        document.querySelector("input[name='name']").value = '';
        document.querySelector("select[name='role']").value = '';
        document.querySelector("input[name='email']").value = '';
        document.querySelector("input[name='mobile']").value = '';
        document.querySelector("input[name='id_number']").value = '';

        // Close the modal (assuming you're using Bootstrap)
        $('#exampleModal').modal('hide');


        window.location.href = `/chamas-bookeeping/members/${localStorage.getItem('groupId')}`;
    })
    .catch(function(error) {
        // Error response, handle accordingly
        var errorMessage = error.message;
        var alertsHub = document.querySelector('.modal-alert-hub');
        alertsHub.innerHTML = '<div class="alert alert-danger" role="alert">' + errorMessage + '</div>';
    });
});


  </script>

  

<script>
  {% comment %} document.getElementById('openIframe').addEventListener('click', function(event) {
      event.preventDefault();
       window.location.href = '/subscriptions/plans/'
  }); {% endcomment %}
  {% comment %} document.getElementById('iframeContainer').classList.add('show'); {% endcomment %}

  {% comment %} document.getElementById('closeIframe').addEventListener('click', function(event) {
      document.getElementById('iframeContainer').classList.remove('show');
  }); {% endcomment %}
</script>

<!-- Mobile Navigation JavaScript -->
<script>
// Mobile Navigation Functions
function openNav() {
    const sidenav = document.getElementById("mySidenav");
    const overlay = document.querySelector(".mobile-overlay");
    const body = document.body;
    
    console.log("Opening navigation sidebar"); // Debug log
    
    if (sidenav) {
        sidenav.style.width = "280px";
        sidenav.style.display = "block";
        console.log("Sidebar width set to 280px"); // Debug log
    }
    
    if (overlay) {
        overlay.style.display = "block";
        overlay.style.opacity = "1";
        console.log("Overlay displayed"); // Debug log
    }
    
    // Add class to body to prevent scrolling
    body.classList.add("sidebar-open");
    
    // Add touch/click event to close on outside click
    setTimeout(() => {
        document.addEventListener('click', outsideClickHandler);
    }, 100);
}

function closeNav() {
    const sidenav = document.getElementById("mySidenav");
    const overlay = document.querySelector(".mobile-overlay");
    const body = document.body;
    
    console.log("Closing navigation sidebar"); // Debug log
    
    if (sidenav) {
        sidenav.style.width = "0";
        setTimeout(() => {
            sidenav.style.display = "none";
        }, 300);
        console.log("Sidebar width set to 0"); // Debug log
    }
    
    if (overlay) {
        overlay.style.opacity = "0";
        setTimeout(() => {
            overlay.style.display = "none";
        }, 300);
        console.log("Overlay hidden"); // Debug log
    }
    
    // Remove class from body
    body.classList.remove("sidebar-open");
    
    // Remove event listener
    document.removeEventListener('click', outsideClickHandler);
}

function outsideClickHandler(event) {
    const sidenav = document.getElementById("mySidenav");
    const menuBtn = document.querySelector('.menu-btn');
    
    // Check if click is outside sidebar and not on menu button
    if (!sidenav.contains(event.target) && !menuBtn.contains(event.target)) {
        closeNav();
    }
}

// Initialize mobile navigation on page load
document.addEventListener('DOMContentLoaded', function() {
    // Ensure mobile overlay exists
    let overlay = document.querySelector('.mobile-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'mobile-overlay';
        document.body.appendChild(overlay);
        console.log("Mobile overlay created");
    }
    
    // Get chama ID from URL for navigation links
    const pathSegments = window.location.pathname.split('/');
    let chamaId = null;
    
    // Look for chama ID in URL pattern like /chama-dashboard/123/ or /contributions/123/
    for (let i = 0; i < pathSegments.length - 1; i++) {
        const nextSegment = pathSegments[i + 1];
        if (nextSegment && !isNaN(nextSegment) && parseInt(nextSegment) > 0) {
            chamaId = parseInt(nextSegment);
            break;
        }
    }
    
    console.log("Detected chama ID:", chamaId);
    
    // Update navigation links with correct URLs if chama ID is found
    if (chamaId) {
        updateNavigationLinks(chamaId);
    }
    
    // Close sidebar on window resize if moving to desktop
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            closeNav();
        }
    });
    
    // Handle swipe gestures for mobile
    let startX = 0;
    let startY = 0;
    
    document.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    });
    
    document.addEventListener('touchmove', function(e) {
        if (!startX || !startY) return;
        
        let currentX = e.touches[0].clientX;
        let currentY = e.touches[0].clientY;
        
        let diffX = startX - currentX;
        let diffY = startY - currentY;
        
        // Swipe left to close sidebar
        if (Math.abs(diffX) > Math.abs(diffY) && diffX > 50) {
            const sidenav = document.getElementById("mySidenav");
            if (sidenav && sidenav.style.width !== "0px" && sidenav.style.width !== "") {
                closeNav();
            }
        }
        
        startX = 0;
        startY = 0;
    });
});

// Function to update navigation links with correct chama ID
function updateNavigationLinks(chamaId) {
    const linkMappings = {
        'dashboard-link': `/chamas/chama-dashboard/${chamaId}/`,
        'finances-link': `/chamas/chama-finances/${chamaId}/`,
        'contribution-link': `/chamas/contributions/${chamaId}/`,
        'loans-link': `/chamas/chama-loans/${chamaId}/`,
        'expenses-link': `/chamas/chama-expenses/${chamaId}/`,
        'fines-link': `/chamas/chama-fines/${chamaId}/`,
        'reports-link': `/chamas/chama-reports/${chamaId}/`,
        'members-link': `/chamas/members/${chamaId}/`,
        'notifications-link': `/chamas/chama-notifications/${chamaId}/`
    };
    
    // Update both mobile and desktop sidebar links
    Object.keys(linkMappings).forEach(className => {
        const mobileLinks = document.querySelectorAll(`#mySidenav .${className}`);
        const desktopLinks = document.querySelectorAll(`.desktop-sidebar .${className}`);
        
        [...mobileLinks, ...desktopLinks].forEach(link => {
            link.href = linkMappings[className];
        });
    });
    
    console.log("Navigation links updated for chama ID:", chamaId);
}
</script>

<!-- Mobile Footer -->
<style>
@media screen and (min-width: 992px) {
    .mbl_footer { display: none !important; }
}
@media screen and (max-width: 991px) {
    body { padding-bottom: 80px !important; }
    .mbl_footer { display: block !important; }
}
</style>
<footer class="mbl_footer" style="background: #2291A5 !important; background-color: #2291A5 !important; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding: 10px 0; display: block;">
    <div class="container">
        <div class="footer_row d-flex flex-row justify-content-between align-items-center" style="padding: 0 15px;">
            <a href="{% url 'my_goals' %}" class="footer_button btn" style="color: #fff; text-decoration: none; display: flex; flex-direction: column; align-items: center; padding: 8px 12px;">
                <img class="homer_white" src="{% static 'images/home_white.png' %}" alt="" style="width: 24px; height: 24px; margin-bottom: 4px; filter: brightness(0) invert(1);">
                <p style="margin: 0; color: #fff; font-size: 12px; text-align: center;">Home</p>
            </a>
            <a href="{% url 'chamas:chamas' %}" class="footer_button btn active" style="color: #fff; text-decoration: none; display: flex; flex-direction: column; align-items: center; padding: 8px 12px; background: rgba(255, 255, 255, 0.2); border-radius: 8px;">
                <img src="{% static 'images/filter_active.png' %}" alt="" style="width: 24px; height: 24px; margin-bottom: 4px; filter: brightness(0) invert(1);">
                <p style="margin: 0; color: #fff; font-size: 12px; text-align: center; font-weight: 600;">Features</p>
            </a>
            <a href="{% url 'wallet_index' %}" class="footer_button btn" style="color: #fff; text-decoration: none; display: flex; flex-direction: column; align-items: center; padding: 8px 12px;">
                <img src="{% static 'images/wallet_alt_fill.png' %}" alt="" style="width: 24px; height: 24px; margin-bottom: 4px; filter: brightness(0) invert(1);">
                <p style="margin: 0; color: #fff; font-size: 12px; text-align: center;">Account</p>
            </a>
            <a href="{% url 'Setting' %}" class="footer_button btn" style="color: #fff; text-decoration: none; display: flex; flex-direction: column; align-items: center; padding: 8px 12px;">
                <img src="{% static 'images/setting.png' %}" alt="" style="width: 24px; height: 24px; margin-bottom: 4px; filter: brightness(0) invert(1);">
                <p style="margin: 0; color: #fff; font-size: 12px; text-align: center;">Settings</p>
            </a>
        </div>
    </div>
</footer>
  

</body>

</html>