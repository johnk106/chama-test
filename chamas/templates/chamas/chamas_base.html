{%load static%}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
    href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
    rel="stylesheet"
  />
    <link rel="stylesheet" href="{%static 'chamas/brand-colors.css'%}" />
    <link rel="stylesheet" href="{%static 'chamas/style.css'%}" />
    <link rel="stylesheet" href="{%static 'chamas/chamas-base.css'%}" />
    <link rel="stylesheet" href="{% static 'css/feather.css' %}">
    <link rel="stylesheet" href="{% static 'css/app-light.css' %}" id="lightTheme">
    <link rel="stylesheet" href="{% static 'css/style-test.css' %}">
    

    {%block head%} {%endblock%}
    <title>Chamas</title>
  </head>
  <body>
    <!-- Main Layout Container -->
    <div class="app-layout">
      
      <!-- Mobile Sidebar (Hidden by default, shown on mobile when menu is clicked) -->
      <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <div class="logo_details">
          <img src="{%static 'chamas/logo.png'%}" alt="Logo" />
        </div>
        <ul class="nav-list">
          <li>
            <a href="{% url 'goals_dashboard' %}">
              <i class='bx bx-arrow-back'></i>
              <span class="link_name">Back to Dashboard</span>
            </a>
          </li>
          <li>
            <a href="#">
              <i class="fa-solid fa-gauge"></i>
              <span class="link_name">Dashboard</span>
            </a>
          </li>
          <li>
            <a href="#">
              <i class="fa-solid fa-group-arrows-rotate"></i>
              <span class="link_name">Merry-go-round chama</span>
            </a>
          </li>
          <li>
            <a href="#" class="bookeeping-window">
              <i class="fa-solid fa-clipboard"></i>
              <span class="link_name">Book keeping</span>
            </a>
          </li>
          <li>
            <a href="#">
              <i class="fa-solid fa-building-columns"></i>
              <span class="link_name">Table Banking</span>
            </a>
          </li>
        </ul>
      </div>
      
      <!-- Desktop Sidebar (Always visible on desktop) -->
      <aside class="desktop-sidebar">
        <div class="sidebar-header">
          <div class="logo_details">
            <img src="{%static 'chamas/logo.png'%}" alt="Logo" />
          </div>
        </div>
        <nav class="sidebar-nav">
          <ul class="nav-list">
            <li>
              <a href="{% url 'goals_dashboard' %}">
                <i class='bx bx-arrow-back'></i>
                <span class="link_name">Back to Dashboard</span>
              </a>
            </li>
            <li>
              <a href="#">
                <i class="fa-solid fa-gauge"></i>
                <span class="link_name">Dashboard</span>
              </a>
            </li>
            <li>
              <a href="#">
                <i class="fa-solid fa-group-arrows-rotate"></i>
                <span class="link_name">Merry-go-round chama</span>
              </a>
            </li>
            <li>
              <a href="#" class="bookeeping-window">
                <i class="fa-solid fa-clipboard"></i>
                <span class="link_name">Book keeping</span>
              </a>
            </li>
            <li>
              <a href="#">
                <i class="fa-solid fa-building-columns"></i>
                <span class="link_name">Table Banking</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content Area -->
      <main class="main-content">

        <div class="page_header pt-3">
          <div class="container">
            <nav class="page_nav mob_nav show_on_mobile">
              <div class="brand">
                <a href="#">
                  <img src="{% static 'images/Chama-Bora_clrd.png' %}" alt="">
                </a>
              </div>
              <ul class="nav-list">
                <li class="" data-toggle="modal" data-target=".modal-notif">
                  <img src="{% static 'images/Notifications.png' %}" alt="">
                </li>
                &nbsp;&nbsp;
                <li class="">
                  <button class="btn navbar-toggler text-muted collapseSidebar" type="button" onclick="openNav()">
                    <img src="{% static 'images/menu.png' %}" class="avatar-img rounded-circle" alt="">
                  </button>
                </li>
              </ul>
            </nav>
          </div>
        </div>
                 <nav class="topnav navbar navbar-light page_header hide_on_mobile">
           <ul class="nav">
            <li class="nav-item">
              <a class="nav-link text-muted my-2" href="#" id="modeSwitcher" data-mode="light">
                <i class="fe fe-sun fe-16" style="font-size:16px; line-height:1; vertical-align:middle;"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-muted my-2" href="./#" data-toggle="modal" data-target=".modal-shortcut">
                <span class="fe fe-grid fe-16" style="font-size:16px; line-height:1; vertical-align:middle;"></span>
              </a>
            </li>
            <li class="nav-item nav-notif">
              <a class="nav-link text-muted my-2" href="./#" data-toggle="modal" data-target=".modal-notif">
                <span class="fe fe-bell fe-16" style="font-size:16px; line-height:1; vertical-align:middle;"></span>
                <span class="dot dot-md bg-success"></span>
              </a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle text-muted pr-0" href="#" id="navbarDropdownMenuLink"
                 role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="avatar avatar-sm mt-2">
                  {% if request.user.profile.picture %}
                    <img src="{{ request.user.profile.picture.url }}" alt="img" class="avatar-img rounded-circle">
                  {% else %}
                    <img src="{% static 'assets/avatars/face-1.png' %}" alt="img" class="avatar-img rounded-circle">
                  {% endif %}
                </span>
              </a>
                              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="{% url 'Setting' %}">Settings</a>
                  <a class="dropdown-item" href="{% url 'Logout' %}">Logout</a>
                </div>
            </li>
          </ul>
                 </nav>
         <div class="chama-subheader" style="background: transparent;">
           <div class="container d-flex justify-content-between align-items-center py-2">
             <div class="chama-name">
               {% if group %}{{ group.name }}{% elif chama %}{{ chama.name }}{% else %}<span id="chamaNameDisplay"></span>{% endif %}
             </div>
             <div class="view-toggle d-flex align-items-center gap-2">
               <div class="form-check form-switch d-none d-lg-block">
                 <input class="form-check-input" type="checkbox" id="viewToggleDesktop">
                 <label class="form-check-label" for="viewToggleDesktop">
                   <span class="switch-label-member">Member</span>
                   <span class="switch-label-admin" style="display: none;">Admin</span>
                 </label>
               </div>
               <div class="form-check form-switch d-block d-lg-none">
                 <input class="form-check-input" type="checkbox" id="viewToggle">
                 <label class="form-check-label" for="viewToggle">
                   <span class="switch-label-member">Member</span>
                   <span class="switch-label-admin" style="display: none;">Admin</span>
                 </label>
               </div>
             </div>
           </div>
         </div>
 
         <!-- Page Content -->
        <div class="page-content">
          {%block body%}
          {%endblock%}
        </div>
      </main>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeNav()"></div>

    <!--Modals-->
    <!--Add members to group modal-->
    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1
              class="modal-title fs-5"
              id="exampleModalLabel"
              style="color: #2291a5"
            >
              Add Member to group
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form action="">
              <div class="mobile-input">
                <label for="mobile">Name</label>
                <input
                  type="text"
                  name="mobile"
                  placeholder="Eg John Doe"
                  class="form-control"
                />
              </div>
              <div class="mobile-input">
                <label for="mobile">Mobile</label>
                <input
                  type="text"
                  name="mobile"
                  placeholder="Eg +2547XXXXXXXX"
                  class="form-control"
                />
              </div>
              <div class="mobile-input">
                <label for="mobile">email</label>
                <input
                  type="email"
                  name="mobile"
                  placeholder="Eg example@email.com"
                  class="form-control"
                />
              </div>
              <div class="mobile-input">
                <label for="mobile">ID Number</label>
                <input
                  type="text"
                  name="mobile"
                  placeholder="Eg 12XXXXXXXX"
                  class="form-control"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary">
              Save changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://kit.fontawesome.com/d90233e428.js" crossorigin="anonymous"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    
    <script>
      /* Enhanced Mobile Navigation Functions */
      function openNav() {
          const sidenav = document.getElementById("mySidenav");
          const overlay = document.querySelector(".mobile-overlay");
          const body = document.body;
          
          console.log("Opening navigation sidebar"); // Debug log
          
          if (sidenav) {
              sidenav.style.width = "280px";
              sidenav.style.display = "block";
              console.log("Sidebar width set to 280px"); // Debug log
          }
          
          if (overlay) {
              overlay.style.display = "block";
              overlay.style.opacity = "1";
              console.log("Overlay displayed"); // Debug log
          }
          
          // Add class to body to prevent scrolling
          body.classList.add("sidebar-open");
          
          // Add touch/click event to close on outside click
          setTimeout(() => {
              document.addEventListener('click', outsideClickHandler);
          }, 100);
      }

      function closeNav() {
          const sidenav = document.getElementById("mySidenav");
          const overlay = document.querySelector(".mobile-overlay");
          const body = document.body;
          
          console.log("Closing navigation sidebar"); // Debug log
          
          if (sidenav) {
              sidenav.style.width = "0";
              setTimeout(() => {
                  sidenav.style.display = "none";
              }, 300);
              console.log("Sidebar width set to 0"); // Debug log
          }
          
          if (overlay) {
              overlay.style.opacity = "0";
              setTimeout(() => {
                  overlay.style.display = "none";
              }, 300);
              console.log("Overlay hidden"); // Debug log
          }
          
          // Remove class from body
          body.classList.remove("sidebar-open");
          
          // Remove event listener
          document.removeEventListener('click', outsideClickHandler);
      }

      function outsideClickHandler(event) {
          const sidenav = document.getElementById("mySidenav");
          const menuBtn = document.querySelector('.menu-btn');
          
          // Check if click is outside sidebar and not on menu button
          if (!sidenav.contains(event.target) && !menuBtn.contains(event.target)) {
              closeNav();
          }
      }

      // Initialize mobile navigation on page load
      document.addEventListener('DOMContentLoaded', function() {
          // Ensure mobile overlay exists
          let overlay = document.querySelector('.mobile-overlay');
          if (!overlay) {
              overlay = document.createElement('div');
              overlay.className = 'mobile-overlay';
              document.body.appendChild(overlay);
          }
          
          // Ensure sidenav links are populated regardless of page
          var groupIdForLinks = localStorage.getItem('groupId');
          if (groupIdForLinks && typeof updateNavigationLinks === 'function') {
              updateNavigationLinks(groupIdForLinks);
          }
          
          // Close sidebar on window resize if moving to desktop
          window.addEventListener('resize', function() {
              if (window.innerWidth > 768) {
                  closeNav();
              }
          });
      });

      $(document).ready(function () {
        // Book keeping window functionality
        $(".bookeeping-window").click(function(e) {
          e.preventDefault();
          // Add your book keeping functionality here
          console.log("Book keeping clicked");
        });
      });
    </script>

<!-- Mobile Footer -->
<style>
@media screen and (min-width: 992px) {
    .mbl_footer { display: none !important; }
}
@media screen and (max-width: 991px) {
    body { padding-bottom: 80px !important; }
    .mbl_footer { display: block !important; }
}
</style>
<footer class="mbl_footer" style="background: #2291A5 !important; background-color: #2291A5 !important; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding: 10px 0; display: block;">
    <div class="container">
        <div class="footer_row d-flex flex-row justify-content-between align-items-center" style="padding: 0 15px;">
            <a href="{% url 'my_goals' %}" class="footer_button btn" style="color: #fff; text-decoration: none; display: flex; flex-direction: column; align-items: center; padding: 8px 12px;">
                <img class="homer_white" src="{% static 'images/home_white.png' %}" alt="" style="width: 24px; height: 24px; margin-bottom: 4px; filter: brightness(0) invert(1);">
                <p style="margin: 0; color: #fff; font-size: 12px; text-align: center;">Home</p>
            </a>
            <a href="{% url 'chamas:chamas' %}" class="footer_button btn active" style="color: #fff; text-decoration: none; display: flex; flex-direction: column; align-items: center; padding: 8px 12px; background: rgba(255, 255, 255, 0.2); border-radius: 8px;">
                <img src="{% static 'images/filter_active.png' %}" alt="" style="width: 24px; height: 24px; margin-bottom: 4px; filter: brightness(0) invert(1);">
                <p style="margin: 0; color: #fff; font-size: 12px; text-align: center; font-weight: 600;">Features</p>
            </a>
            <a href="{% url 'wallet_index' %}" class="footer_button btn" style="color: #fff; text-decoration: none; display: flex; flex-direction: column; align-items: center; padding: 8px 12px;">
                <img src="{% static 'images/wallet_alt_fill.png' %}" alt="" style="width: 24px; height: 24px; margin-bottom: 4px; filter: brightness(0) invert(1);">
                <p style="margin: 0; color: #fff; font-size: 12px; text-align: center;">Account</p>
            </a>
            <a href="{% url 'Setting' %}" class="footer_button btn" style="color: #fff; text-decoration: none; display: flex; flex-direction: column; align-items: center; padding: 8px 12px;">
                <img src="{% static 'images/setting.png' %}" alt="" style="width: 24px; height: 24px; margin-bottom: 4px; filter: brightness(0) invert(1);">
                <p style="margin: 0; color: #fff; font-size: 12px; text-align: center;">Settings</p>
            </a>
        </div>
    </div>
</footer>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.collapseSidebar').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        if (typeof openNav === 'function') { openNav(); }
      });
    });
    document.querySelectorAll('.nav-item.dropdown .dropdown-toggle').forEach(function(a){
      a.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        var menu = this.parentElement.querySelector('.dropdown-menu');
        if(menu){ menu.classList.toggle('show'); }
      });
    });
    // Populate chama name from localStorage if not provided by context
    var nameEl = document.getElementById('chamaNameDisplay');
    if (nameEl && (!nameEl.textContent || nameEl.textContent.trim() === '')) {
      var storedName = localStorage.getItem('groupName');
      if (storedName) { nameEl.textContent = storedName; }
    }
  });
  </script>
  <script>
  $(document).ready(function() {
    var groupId = localStorage.getItem('groupId');
    var storageKey = groupId ? ("selectedView_" + groupId) : "selectedView";
    var savedView = localStorage.getItem(storageKey) || "member";

    // Default state: disable toggles until role verified
    $("#viewToggle, #viewToggleDesktop").prop('disabled', true);

    // Initialize labels and switches
    if (savedView === "member") {
      $("#viewToggle, #viewToggleDesktop").prop('checked', false);
      $(".switch-label-member").show();
      $(".switch-label-admin").hide();
      updateView("member");
    } else {
      $("#viewToggle, #viewToggleDesktop").prop('checked', true);
      $(".switch-label-member").hide();
      $(".switch-label-admin").show();
      updateView("admin");
    }

    // Verify role if we have a group
    if (groupId) {
      $.ajax({
        url: '/chamas-bookeeping/get_user_role/',
        data: { group_id: groupId },
        dataType: 'json',
        success: function(data) {
          if (data.role !== "admin" || data.error) {
            savedView = "member";
            $("#viewToggle, #viewToggleDesktop").prop('checked', false).prop('disabled', true);
            $(".switch-label-member").show();
            $(".switch-label-admin").hide();
            updateView("member");
            localStorage.setItem(storageKey, "member");
          } else {
            $("#viewToggle, #viewToggleDesktop").prop('disabled', false);
            if (savedView === "admin") {
              $("#viewToggle, #viewToggleDesktop").prop('checked', true);
              $(".switch-label-member").hide();
              $(".switch-label-admin").show();
              updateView("admin");
            } else {
              $("#viewToggle, #viewToggleDesktop").prop('checked', false);
              $(".switch-label-member").show();
              $(".switch-label-admin").hide();
              updateView("member");
            }
          }
        },
        error: function() {
          $("#viewToggle, #viewToggleDesktop").prop('checked', false).prop('disabled', true);
          $(".switch-label-member").show();
          $(".switch-label-admin").hide();
          updateView("member");
          localStorage.setItem(storageKey, "member");
        }
      });
    }

    // Toggle change handler
    $("#viewToggle, #viewToggleDesktop").on("change", function() {
      var isAdminView = $(this).is(':checked');
      if (isAdminView) {
        if (!groupId) {
          alert("You don't have admin permissions");
          $("#viewToggle, #viewToggleDesktop").prop('checked', false);
          $(".switch-label-member").show();
          $(".switch-label-admin").hide();
          updateView("member");
          localStorage.setItem(storageKey, "member");
          return;
        }
        $.ajax({
          url: '/chamas-bookeeping/get_user_role/',
          data: { group_id: groupId },
          dataType: 'json',
          success: function(data) {
            if (data.role === "admin") {
              $("#viewToggle, #viewToggleDesktop").prop('checked', true);
              $(".switch-label-member").hide();
              $(".switch-label-admin").show();
              updateView("admin");
              localStorage.setItem(storageKey, "admin");
            } else {
              alert("You don't have admin permissions");
              $("#viewToggle, #viewToggleDesktop").prop('checked', false);
              $(".switch-label-member").show();
              $(".switch-label-admin").hide();
              updateView("member");
              localStorage.setItem(storageKey, "member");
            }
          },
          error: function() {
            alert("Unable to verify permissions");
            $("#viewToggle, #viewToggleDesktop").prop('checked', false);
            $(".switch-label-member").show();
            $(".switch-label-admin").hide();
            updateView("member");
            localStorage.setItem(storageKey, "member");
          }
        });
      } else {
        updateView("member");
        $("#viewToggle, #viewToggleDesktop").prop('checked', false);
        $(".switch-label-member").show();
        $(".switch-label-admin").hide();
        localStorage.setItem(storageKey, "member");
      }
    });

    function updateView(view) {
      if (view === "member") {
        $("body, html").removeClass("user-is-admin");
        $(".admin, #remove-user, #add-member-button").hide();
        $(".member").show();
      } else {
        $("body, html").addClass("user-is-admin");
        $(".member").hide();
        $(".admin, #remove-user, #add-member-button").show();
      }
    }
  });
  </script>
</body>
</html>
