{%extends 'chamas/base.html'%}{% load static %}{% load humanize %}

{%block head%}
<title>Contributions</title>
<link rel="stylesheet" href="{%static 'chamas/contribution.css'%}">
<link rel="stylesheet" href="{%static 'chamas/dashboard.css'%}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{%endblock%}

{%block body%}
<div class="modern-contributions">
    <!-- Floating Menu Button for Mobile -->
    <button class="floating-menu-btn d-block d-md-none" onclick="openNav()">
        <i class='bx bx-menu'></i>
    </button>
    
    <!-- Sidebar Backdrop for Mobile -->
    <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeNav()"></div>

    <!-- Mobile View -->
    <div class="mobile-contributions d-block d-lg-none">
        <!-- Search Bar -->
        <div class="mobile-search-header">
            <button class="btn-back" onclick="window.history.back()">
                <i class='bx bx-arrow-left'></i>
            </button>
            <div class="search-container">
                <i class='bx bx-search search-icon'></i>
                <input type="text" placeholder="Search Contributions" class="search-input" id="mobile-search">
                <button class="btn-voice">
                    <i class='bx bx-microphone'></i>
                </button>
                <button class="btn-filter">
                    <i class='bx bx-filter-alt'></i>
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mobile-tabs">
            <button class="tab-btn active" data-tab="all-contributions">All Contributions</button>
            <button class="tab-btn admin" data-tab="create-contributions">Create Contributions</button>
        </div>

        <!-- All Contributions Tab Content -->
        <div class="tab-content active" id="all-contributions">
            <!-- Contribute Section -->
            <div class="contribute-section">
                <div class="contribute-header">
                    <div class="contribute-icon">
                        <i class='bx bx-bolt'></i>
                    </div>
                    <span class="contribute-text">Contribute</span>
                </div>
            </div>

            <!-- Contributions List -->
            <div class="mobile-contributions-list">
                {%for contribution in contributions%}
                <div class="mobile-contribution-card" data-contribution-name="{{contribution.name}}">
                    <div class="contribution-header">
                        <div class="contribution-info">
                            <div class="contribution-type">
                                <span class="type-label">Type</span>
                                <span class="type-value">{{contribution.name}}</span>
                            </div>
                            <div class="contribution-due">
                                <span class="due-label">Due date</span>
                                <span class="due-value">{{contribution.end_date|date:"d/m/Y"}}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="contribution-amount">
                        <span class="amount-label">Target Amount</span>
                        <span class="amount-value">Ksh{{contribution.amount|intcomma}}</span>
                    </div>

                    <div class="members-contribution-section">
                        <button class="members-toggle" data-contribution-id="{{contribution.id}}">
                            <span class="toggle-text">Members and contributed amount</span>
                            <i class='bx bx-chevron-down toggle-icon'></i>
                        </button>
                        
                        <div class="members-details" style="display: none;">
                            <div class="members-table-header">
                                <span>Members Name</span>
                                <span>Balance</span>
                                <span>Enter amount</span>
                            </div>
                            <div class="members-list" id="members-list-{{contribution.id}}">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            <button class="update-contribution-btn admin" data-contribution-id="{{contribution.id}}">
                                Update contribution
                            </button>
                        </div>
                    </div>
                </div>
                {%empty%}
                <div class="no-contributions">
                    <i class='bx bx-inbox'></i>
                    <p>No contributions found</p>
                </div>
                {%endfor%}
            </div>
        </div>

        <!-- Create Contributions Tab Content -->
        <div class="tab-content admin" id="create-contributions">
            <!-- Contribute Section -->
            <div class="contribute-section">
                <div class="contribute-header">
                    <div class="contribute-icon">
                        <i class='bx bx-bolt'></i>
                    </div>
                    <span class="contribute-text">Contribute</span>
                </div>
            </div>

            <!-- Create Contribution Form -->
            <div class="mobile-create-form">
                <form id="mobile-create-contribution-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mobile-contribution-id">Contribution ID</label>
                            <select id="mobile-contribution-id" name="contribution-id" class="form-input">
                                <option value="">Select Contribution ID</option>
                                <!-- Add options as needed -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mobile-due-date">Due date</label>
                            <input type="date" id="mobile-due-date" name="end-date" class="form-input" placeholder="Enter due date">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mobile-contribution-name">Name</label>
                            <input type="text" id="mobile-contribution-name" name="name" class="form-input" placeholder="Enter Contribution name">
                        </div>
                        <div class="form-group">
                            <label for="mobile-target-amount">Target contribution</label>
                            <input type="number" id="mobile-target-amount" name="amount" class="form-input" placeholder="Enter Amount">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="mobile-description">Description</label>
                        <textarea id="mobile-description" name="description" class="form-input" rows="3" placeholder="Enter description for contribution"></textarea>
                    </div>

                    <button type="button" class="create-contribution-btn" id="mobile-create-contribution-button">
                        Create contribution Scheme
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Desktop View -->
    <div class="desktop-contributions d-none d-lg-block">
        <div class="desktop-content">
            <!-- Desktop Header -->
            <div class="desktop-header-section">
                <h1 class="page-title">Contributions</h1>
                <div class="desktop-actions">
                    <button class="btn-secondary">
                        <i class='bx bx-filter'></i>
                        Filter
                    </button>
                    <button class="btn-primary admin" id="desktop-create-toggle">
                        <i class='bx bx-plus'></i>
                        Create Contribution
                    </button>
                </div>
            </div>

            <div class="desktop-layout">
                <!-- Left Panel - Create Form & Contributions List -->
                <div class="left-panel">
                    <!-- Create Contribution Form -->
                    <div class="create-contribution-card admin" id="desktop-create-form">
                        <h3 class="card-title">Create Contribution</h3>
                        <div class="create-contribution-alert-hub"></div>
                        <form action="" id="create-contribution-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="name">Name</label>
                                    <input type="text" name="name" id="name" class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="amount">Amount</label>
                                    <input type="number" name="amount" id="amount" class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="start-date">Start date</label>
                                    <input type="date" name="start-date" id="start-date" class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="end-date">End date</label>
                                    <input type="date" name="end-date" id="end-date" class="form-input" />
                                </div>
                                <div class="form-group">
                                    <label for="grace-period">Grace period</label>
                                    <input type="number" name="grace-period" id="grace-period" class="form-input" />
                                </div>
                                <div class="form-group full-width">
                                    <label for="description">Description</label>
                                    <textarea name="description" id="description" rows="3" class="form-input" placeholder="Enter contribution description"></textarea>
                                </div>
                            </div>
                            <button class="btn-primary" id="create-contribution-button" type="button">
                                Create Contribution
                            </button>
                        </form>
                    </div>

                    <!-- Contributions List -->
                    <div class="contribution-list-card">
                        <h3 class="card-title">Contribution List</h3>
                        <div class="contributions-grid">
                            {%for contribution in contributions%}
                            <div class="contribution-item" data-contribution-name="{{contribution.name}}">
                                <div class="contribution-name">{{contribution.name}}</div>
                                <div class="contribution-amount">Ksh {{contribution.amount|intcomma}}</div>
                            </div>
                            {%empty%}
                            <div class="no-contributions">
                                <p>No contributions found</p>
                            </div>
                            {%endfor%}
                        </div>
                    </div>
                </div>

                <!-- Right Panel - Contribution Details -->
                <div class="right-panel">
                    <div class="contribution-details-section">
                        <h3 class="details-title">
                            Contribution Details - 
                            <span id="contribution-details-name">Select a contribution</span>
                        </h3>
                        <p style="display: none" id="contribution-id"></p>
                        <div class="contribution-details-alert-hub"></div>

                        <!-- Member Update Table -->
                        <div class="member-update-card admin">
                            <h4 class="card-subtitle">Update Member Contributions</h4>
                            <div class="table-responsive">
                                <table class="table" id="member-list">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Required Amount</th>
                                            <th>Enter Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {%for member in members%}
                                        {%if member.active == True%}
                                        <tr>
                                            <td>{{member.name}}</td>
                                            <td>Ksh <span class="contribution-details-amount">0</span></td>
                                            <td style="display: none" id="member-id">{{member.id}}</td>
                                            <td>
                                                <input type="number" id="amount" name="amount" class="amount-input" placeholder="0" />
                                            </td>
                                        </tr>
                                        {%endif%}
                                        {%endfor%}
                                    </tbody>
                                </table>
                                <button class="btn-primary" id="update-contributions">
                                    Update Contributions
                                </button>
                            </div>
                        </div>

                        <!-- Contribution Records -->
                        <div class="contribution-records-card">
                            <h4 class="card-subtitle">Contribution Records</h4>
                            <div class="table-responsive" id="contribution-records">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Member</th>
                                            <th>Contribution</th>
                                            <th>Amount</th>
                                            <th>Balance</th>
                                            <th class="admin">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals (keeping existing functionality) -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Pay Contribution</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="pay-contribution-alerts"></div>
                <div class="mb-3">
                    <label for="repayment-amount" class="form-label">Amount</label>
                    <input type="number" class="form-control" id="repayment-amount">
                </div>
                <input type="hidden" value="" id="contribution-record-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" style="background-color: #2291a5;" id="pay-modal-button">Pay</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="fineContribution" tabindex="-1" aria-labelledby="fineContributionLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="fineContributionLabel">Fine Contribution</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="fine-contribution-alerts"></div>
                <select class="form-select" aria-label="Default select example" id="fine-type">
                    <label for="fine-type">Fine Type</label>
                    {%for type in fine_types%}
                    <option value="{{type.id}}">{{type.name}}</option>
                    {%endfor%}
                </select>
                <input type="hidden" value="" id="fine-contribution-record-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" style="background-color: #2291a5;" id="fine-modal-button">Fine</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
$(document).ready(function () {
    // Mobile tab functionality
    $('.tab-btn').click(function() {
        const tabId = $(this).data('tab');
        
        // Update active tab
        $('.tab-btn').removeClass('active');
        $(this).addClass('active');
        
        // Update active content
        $('.tab-content').removeClass('active');
        $('#' + tabId).addClass('active');
    });

    // Mobile members toggle
    $('.members-toggle').click(function() {
        const contributionId = $(this).data('contribution-id');
        const membersDetails = $(this).closest('.members-contribution-section').find('.members-details');
        const toggleIcon = $(this).find('.toggle-icon');
        
        if (membersDetails.is(':visible')) {
            membersDetails.slideUp();
            toggleIcon.removeClass('bx-chevron-up').addClass('bx-chevron-down');
        } else {
            membersDetails.slideDown();
            toggleIcon.removeClass('bx-chevron-down').addClass('bx-chevron-up');
            loadMembersForMobile(contributionId);
        }
    });

    // Desktop create form toggle
    $('#desktop-create-toggle').click(function() {
        $('#desktop-create-form').slideToggle();
    });

    // Mobile search functionality
    $('#mobile-search').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.mobile-contribution-card').each(function() {
            const contributionName = $(this).find('.type-value').text().toLowerCase();
            if (contributionName.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });

    // Enhanced mobile navigation functions
    window.openNav = function() {
        document.getElementById("mySidenav").style.width = "250px";
        
        if (window.innerWidth <= 767) {
            document.getElementById("sidebarBackdrop").classList.add("show");
            document.body.classList.add("sidebar-open");
        } else {
            document.getElementById("main").style.marginLeft = "150px";
        }
    }

    window.closeNav = function() {
        document.getElementById("mySidenav").style.width = "0";
        document.getElementById("sidebarBackdrop").classList.remove("show");
        document.body.classList.remove("sidebar-open");
        
        if (window.innerWidth > 767) {
            document.getElementById("main").style.marginLeft = "0";
        }
    }

    // Load members for mobile view
    function loadMembersForMobile(contributionId) {
        // This function will populate the members list for mobile
        // You can implement this based on your existing data structure
        const membersList = $('#members-list-' + contributionId);
        membersList.html(`
            {%for member in members%}
            {%if member.active == True%}
            <div class="member-row">
                <div class="member-info">
                    <div class="member-avatar">
                        <img src="{% if member.profile %}{{ member.profile.url }}{% else %}data:image/png;base64,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{% endif %}" alt="{{member.name}}">
                    </div>
                    <span class="member-name">{{member.name}}</span>
                </div>
                <div class="member-balance">Ksh1000</div>
                <div class="member-input">
                    <input type="number" placeholder="Enter amount" class="amount-input-mobile">
                </div>
            </div>
            {%endif%}
            {%endfor%}
        `);
    }

    // Existing JavaScript functionality (keeping all original functions)
    function submitContributionForm() {
        var formData = $("#create-contribution-form").serialize();
        var chama_id = localStorage.getItem("groupId");

        if (!chama_id) {
            console.error("Invalid chama_id");
            return;
        }

        var csrfToken = getCookie("csrftoken");
        if (!csrfToken) {
            console.error("CSRF token not found");
            return;
        }

        $.ajaxSetup({
            headers: { "X-CSRFToken": csrfToken }
        });

        $.ajax({
            url: `/chamas-bookeeping/create-contribution/${chama_id}/`,
            type: "POST",
            data: formData,
            success: function (response) {
                if (response.status == "success") {
                    $(".create-contribution-alert-hub").html(`
                        <div class="alert alert-success" role="alert">
                            ${response.message}
                        </div>
                    `);
                    $("#create-contribution-form")[0].reset();
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    $(".create-contribution-alert-hub").html(`
                        <div class="alert alert-danger" role="alert">
                            ${response.message}
                        </div>
                    `);
                }
            },
            error: function (xhr, status, error) {
                console.error(error);
                $(".create-contribution-alert-hub").html(`
                    <div class="alert alert-danger" role="alert">
                        An error occurred. Please try again.
                    </div>
                `);
            }
        });
    }

    // Mobile create contribution
    $("#mobile-create-contribution-button").click(function () {
        var formData = $("#mobile-create-contribution-form").serialize();
        var chama_id = localStorage.getItem("groupId");

        if (!chama_id) {
            console.error("Invalid chama_id");
            return;
        }

        var csrfToken = getCookie("csrftoken");
        if (!csrfToken) {
            console.error("CSRF token not found");
            return;
        }

        $.ajaxSetup({
            headers: { "X-CSRFToken": csrfToken }
        });

        $.ajax({
            url: `/chamas-bookeeping/create-contribution/${chama_id}/`,
            type: "POST",
            data: formData,
            success: function (response) {
                if (response.status == "success") {
                    alert("Contribution created successfully!");
                    $("#mobile-create-contribution-form")[0].reset();
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    alert(response.message);
                }
            },
            error: function (xhr, status, error) {
                console.error(error);
                alert("An error occurred. Please try again.");
            }
        });
    });

    $("#create-contribution-button").click(submitContributionForm);

    // Function to handle click on a contribution item
    function fetchAndRenderContributionDetails(contributionName) {
        const chamaId = localStorage.getItem("groupId");
        const csrfToken = getCookie("csrftoken");

        $.ajaxSetup({
            headers: { "X-CSRFToken": csrfToken }
        });

        $.ajax({
            url: `/chamas-bookeeping/retrieve-contribution/${chamaId}/`,
            type: "POST",
            data: JSON.stringify({ name: contributionName }),
            contentType: "application/json",
            success: function (response) {
                if (response.status !== "success") {
                    alert("Failed to retrieve contribution details. Please try again.");
                    return;
                }

                $("#contribution-details-name").text(response.contribution.name);
                $("#contribution-id").text(response.contribution.id);
                $(".contribution-details-amount").text(response.contribution.amount);

                const tbody = $("#contribution-records tbody");
                tbody.empty();

                response.records.results.forEach(record => {
                    const date = new Date(record.date_created).toLocaleDateString();
                    const member = record.member;
                    const contrib = record.contribution;
                    const paid = parseFloat(record.amount_paid).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const bal = parseFloat(record.balance).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                    let rowHtml;
                    if (localStorage.getItem('selectedView') === 'admin') {
                        rowHtml = `
                            <tr data-record-id="${record.id}" id="record-id">
                                <td>${date}</td>
                                <td>${member}</td>
                                <td>${contrib}</td>
                                <td>ksh ${paid}</td>
                                <td>ksh ${bal}</td>
                                <td class="admin">
                                    <button type="button" class="btn btn-sm table-fine-button" 
                                            data-bs-toggle="modal" data-bs-target="#fineContribution">
                                        Fine
                                    </button>
                                    <button type="button" class="btn btn-sm table-pay-button" 
                                            data-bs-toggle="modal" data-bs-target="#exampleModal">
                                        Pay
                                    </button>
                                </td>
                            </tr>`;
                    } else {
                        rowHtml = `
                            <tr data-record-id="${record.id}">
                                <td>${date}</td>
                                <td>${member}</td>
                                <td>${contrib}</td>
                                <td>ksh ${paid}</td>
                                <td>ksh ${bal}</td>
                            </tr>`;
                    }

                    tbody.append(rowHtml);
                });
            },
            error: function () {
                alert("Failed to retrieve contribution details. Please try again.");
            }
        });
    }

    // Click handlers for contribution items
    $(document).on('click', '.contribution-item', function() {
        const contributionName = $(this).data('contribution-name');
        fetchAndRenderContributionDetails(contributionName);
        
        // Highlight selected item
        $('.contribution-item').removeClass('selected');
        $(this).addClass('selected');
    });

    $(document).on('click', '.mobile-contribution-card', function() {
        const contributionName = $(this).data('contribution-name');
        fetchAndRenderContributionDetails(contributionName);
    });

    // Function to get the value of a cookie by name
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            var cookies = document.cookie.split(";");
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Update contributions functionality
    $("#update-contributions").click(function () {
        const contributionId = $("#contribution-id").text();
        const chamaId = localStorage.getItem("groupId");
        const csrfToken = getCookie("csrftoken");

        if (!contributionId) {
            alert("Please select a contribution first.");
            return;
        }

        const contributionData = [];
        $("#member-list tbody tr").each(function () {
            const memberId = $(this).find("#member-id").text();
            const amount = $(this).find("input[name='amount']").val();
            
            if (amount && amount > 0) {
                contributionData.push({
                    member_id: memberId,
                    amount: amount
                });
            }
        });

        if (contributionData.length === 0) {
            alert("Please enter at least one contribution amount.");
            return;
        }

        $.ajaxSetup({
            headers: { "X-CSRFToken": csrfToken }
        });

        $.ajax({
            url: `/chamas-bookeeping/create-contribution-record/${chamaId}/`,
            type: "POST",
            data: JSON.stringify({
                contribution_id: contributionId,
                contributions: contributionData
            }),
            contentType: "application/json",
            success: function (response) {
                if (response.status === "success") {
                    $(".contribution-details-alert-hub").html(`
                        <div class="alert alert-success" role="alert">
                            ${response.message}
                        </div>
                    `);
                    // Clear input fields
                    $("#member-list tbody input").val("");
                    // Refresh contribution details
                    fetchAndRenderContributionDetails($("#contribution-details-name").text());
                } else {
                    $(".contribution-details-alert-hub").html(`
                        <div class="alert alert-danger" role="alert">
                            ${response.message}
                        </div>
                    `);
                }
            },
            error: function () {
                $(".contribution-details-alert-hub").html(`
                    <div class="alert alert-danger" role="alert">
                        Failed to update contributions. Please try again.
                    </div>
                `);
            }
        });
    });

    // Modal functionality for payments and fines
    $(document).on('click', '.table-pay-button', function() {
        const recordId = $(this).closest('tr').data('record-id');
        $('#contribution-record-id').val(recordId);
    });

    $(document).on('click', '.table-fine-button', function() {
        const recordId = $(this).closest('tr').data('record-id');
        $('#fine-contribution-record-id').val(recordId);
    });

    $('#pay-modal-button').click(function() {
        const amount = $('#repayment-amount').val();
        const recordId = $('#contribution-record-id').val();
        const csrfToken = getCookie("csrftoken");

        if (!amount || amount <= 0) {
            alert("Please enter a valid amount.");
            return;
        }

        $.ajaxSetup({
            headers: { "X-CSRFToken": csrfToken }
        });

        $.ajax({
            url: `/chamas-bookeeping/pay-contribution/${recordId}/`,
            type: "POST",
            data: JSON.stringify({ amount: amount }),
            contentType: "application/json",
            success: function(response) {
                if (response.status === "success") {
                    $('#exampleModal').modal('hide');
                    alert("Payment recorded successfully!");
                    fetchAndRenderContributionDetails($("#contribution-details-name").text());
                } else {
                    $('.pay-contribution-alerts').html(`
                        <div class="alert alert-danger" role="alert">
                            ${response.message}
                        </div>
                    `);
                }
            },
            error: function() {
                $('.pay-contribution-alerts').html(`
                    <div class="alert alert-danger" role="alert">
                        Failed to process payment. Please try again.
                    </div>
                `);
            }
        });
    });

    $('#fine-modal-button').click(function() {
        const fineType = $('#fine-type').val();
        const recordId = $('#fine-contribution-record-id').val();
        const csrfToken = getCookie("csrftoken");

        if (!fineType) {
            alert("Please select a fine type.");
            return;
        }

        $.ajaxSetup({
            headers: { "X-CSRFToken": csrfToken }
        });

        $.ajax({
            url: `/chamas-bookeeping/fine-contribution/${recordId}/`,
            type: "POST",
            data: JSON.stringify({ fine_type_id: fineType }),
            contentType: "application/json",
            success: function(response) {
                if (response.status === "success") {
                    $('#fineContribution').modal('hide');
                    alert("Fine applied successfully!");
                    fetchAndRenderContributionDetails($("#contribution-details-name").text());
                } else {
                    $('.fine-contribution-alerts').html(`
                        <div class="alert alert-danger" role="alert">
                            ${response.message}
                        </div>
                    `);
                }
            },
            error: function() {
                $('.fine-contribution-alerts').html(`
                    <div class="alert alert-danger" role="alert">
                        Failed to apply fine. Please try again.
                    </div>
                `);
            }
        });
    });
});
</script>
{%endblock%}