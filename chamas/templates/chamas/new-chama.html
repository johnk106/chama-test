{%extends 'chamas/chamas_base.html'%}
{%load static%}

{%block head%}
<title>Create New Chama</title>
<link rel="stylesheet" href="{%static 'chamas/new-chama.css'%}">
{%endblock%}

{%block body%}

<!-- Modern Mobile-First Create Chama Page -->
<div class="create-chama-container">
    <!-- Enhanced Header Section -->
    <div class="chama-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-icon-wrapper">
                    <i class='bx bx-group'></i>
                </div>
                <div class="header-text">
                    <h1 class="page-title">Create New Group</h1>
                    <p class="page-subtitle">Set up your chama and invite members</p>
                </div>
            </div>
            <div class="header-right">
                <div class="progress-indicator">
                    <div class="progress-step active">
                        <span class="step-number">1</span>
                        <span class="step-label">Details</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <span class="step-number">2</span>
                        <span class="step-label">Members</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div class="alert-container" id="alertCluster"></div>

    <!-- Main Form Section -->
    <div class="form-container">
        <div class="form-card">
            <form id="createChamaForm" class="chama-form">
                {% csrf_token %}
                
                <!-- Chama Name Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class='bx bx-edit-alt'></i>
                        </div>
                        <h3 class="section-title">Basic Information</h3>
                    </div>
                    
                    <div class="input-group-modern">
                        <label for="name" class="input-label">
                            <i class='bx bx-hash'></i>
                            Chama Name
                            <span class="required">*</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="text" name="name" id="name" placeholder="Enter your chama name" required>
                            <div class="input-focus-border"></div>
                        </div>
                    </div>
                </div>

                <!-- Group Type Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class='bx bx-category'></i>
                        </div>
                        <h3 class="section-title">Group Type</h3>
                    </div>
                    
                    <div class="input-group-modern">
                        <label for="type" class="input-label">
                            <i class='bx bx-list-ul'></i>
                            Select Group Type
                            <span class="required">*</span>
                        </label>
                        <div class="select-wrapper">
                            <select name="type" id="type" required>
                                <option value="">Choose group type...</option>
                                {%for type in types%}
                                <option value="{{type.id}}">{{type.name}}</option>
                                {%endfor%}
                            </select>
                            <i class='bx bx-chevron-down select-arrow'></i>
                        </div>
                    </div>
                </div>

                <!-- Start Date Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class='bx bx-calendar'></i>
                        </div>
                        <h3 class="section-title">Start Date</h3>
                    </div>
                    
                    <div class="input-group-modern">
                        <label for="date" class="input-label">
                            <i class='bx bx-calendar-check'></i>
                            Start Date
                            <span class="required">*</span>
                        </label>
                        <div class="input-wrapper">
                            <input type="date" name="date" id="date" required>
                            <div class="input-focus-border"></div>
                        </div>
                    </div>
                </div>

                <!-- Members Section -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class='bx bx-user-plus'></i>
                        </div>
                        <h3 class="section-title">Add Members</h3>
                    </div>
                    
                    <div class="add-members-card" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="resetMemberForm()">
                        <div class="add-members-content">
                            <div class="add-icon">
                                <i class='bx bx-user-plus'></i>
                            </div>
                            <div class="add-text">
                                <h4>Add Members</h4>
                                <p>Invite people to join your chama</p>
                            </div>
                            <div class="add-arrow">
                                <i class='bx bx-chevron-right'></i>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Selected Members Sidebar -->
        <div class="members-sidebar">
            <div class="members-header">
                <div class="members-title">
                    <i class='bx bx-group'></i>
                    <h3>Selected Members</h3>
                </div>
                <div class="members-count" id="membersCount">
                    <span class="count-number">0</span>
                    <span class="count-label">members</span>
                </div>
            </div>
            
            <div class="members-list" id="memberList">
                <div class="empty-state" id="emptyMessage">
                    <div class="empty-icon">
                        <i class='bx bx-user-circle'></i>
                    </div>
                    <h4>No Members Yet</h4>
                    <p>Start by adding members to your chama</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Button -->
    <div class="create-button-container">
        <button class="create-chama-btn" id="createChamaBtn">
            <div class="btn-content">
                <i class='bx bx-plus-circle'></i>
                <span class="btn-text">Create Chama</span>
            </div>
            <div class="btn-loading" style="display: none;">
                <div class="spinner"></div>
                <span>Creating...</span>
            </div>
        </button>
    </div>
</div>

<!-- Enhanced Modal for adding members -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modern-modal">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">
                        <i class='bx bx-user-plus'></i>
                    </div>
                    <div class="modal-title-content">
                        <h1 class="modal-title" id="exampleModalLabel">Add Member to Group</h1>
                        <p class="modal-subtitle">Enter member details below</p>
                    </div>
                </div>
                <button type="button" class="btn-close modern-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addMemberForm" class="modern-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="memberName" class="form-label">
                                <i class='bx bx-user'></i>
                                Full Name
                                <span class="required">*</span>
                            </label>
                            <input type="text" name="name" id="memberName" placeholder="Enter full name" class="form-control modern-input" required />
                        </div>
                        <div class="form-group">
                            <label for="memberMobile" class="form-label">
                                <i class='bx bx-phone'></i>
                                Mobile Number
                                <span class="required">*</span>
                            </label>
                            <input type="text" name="mobile" id="memberMobile" placeholder="+254 7XX XXX XXX" class="form-control modern-input" required />
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="memberEmail" class="form-label">
                                <i class='bx bx-envelope'></i>
                                Email Address
                                <span class="required">*</span>
                            </label>
                            <input type="email" name="email" id="memberEmail" placeholder="example@email.com" class="form-control modern-input" required />
                        </div>
                        <div class="form-group">
                            <label for="memberIdNumber" class="form-label">
                                <i class='bx bx-id-card'></i>
                                ID Number
                            </label>
                            <input type="text" name="id_number" id="memberIdNumber" placeholder="12345678" class="form-control modern-input" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="memberRole" class="form-label">
                            <i class='bx bx-badge'></i>
                            Role
                            <span class="required">*</span>
                        </label>
                        <select name="role" id="memberRole" class="form-control modern-select" required>
                            <option value="">Select member role...</option>
                            {% for role in roles %}
                            <option value="{{role.id}}">{{role.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modern-btn-secondary" data-bs-dismiss="modal">
                    <i class='bx bx-x'></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-primary modern-btn-primary" id="addMemberBtn">
                    <i class='bx bx-plus'></i>
                    Add Member
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let temporaryMembers = [];
let memberCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date to today
    const dateInput = document.getElementById('date');
    const today = new Date().toISOString().split('T')[0];
    dateInput.setAttribute('min', today);
    
    // Add member functionality
    document.getElementById('addMemberBtn').addEventListener('click', function() {
        addMemberToList();
    });
    
    // Create chama functionality
    document.getElementById('createChamaBtn').addEventListener('click', function() {
        createChama();
    });
    
    // Form submit handler for modal
    document.getElementById('addMemberForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addMemberToList();
    });
    
    // Reset form when modal is closed
    document.getElementById('exampleModal').addEventListener('hidden.bs.modal', function() {
        resetMemberForm();
    });
});

function addMemberToList() {
    const form = document.getElementById('addMemberForm');
    const formData = new FormData(form);
    const editingId = form.dataset.editingId;
    
    const name = formData.get('name').trim();
    const mobile = formData.get('mobile').trim();
    const email = formData.get('email').trim();
    const idNumber = formData.get('id_number').trim();
    const roleId = formData.get('role');
    
    // Get role name
    const roleSelect = document.getElementById('memberRole');
    const roleName = roleSelect.options[roleSelect.selectedIndex].text;
    
    // Validation
    if (!name || !mobile || !email || !roleId) {
        showAlert('Please fill in all required fields', 'danger');
        return;
    }
    
    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showAlert('Please enter a valid email address', 'danger');
        return;
    }
    
    // Phone number validation and formatting
    let formattedMobile = mobile.trim();
    if (formattedMobile) {
        // Remove any spaces or dashes
        formattedMobile = formattedMobile.replace(/[\s-]/g, '');
        
        // Basic validation for Kenyan phone numbers
        if (!/^(\+254|254|0)?[17]\d{8}$/.test(formattedMobile)) {
            showAlert('Please enter a valid Kenyan mobile number (e.g., 0712345678 or +254712345678)', 'danger');
            return;
        }
        
        // Format to international format
        if (formattedMobile.startsWith('0')) {
            formattedMobile = '+254' + formattedMobile.slice(1);
        } else if (formattedMobile.startsWith('254') && !formattedMobile.startsWith('+')) {
            formattedMobile = '+' + formattedMobile;
        } else if (!formattedMobile.startsWith('+254')) {
            formattedMobile = '+254' + formattedMobile;
        }
    }
    
    // Check for duplicates (excluding the member being edited)
    const isDuplicate = temporaryMembers.some(member => 
        member.id !== editingId && (
            member.email.toLowerCase() === email.toLowerCase() || 
            member.mobile === formattedMobile
        )
    );
    
    if (isDuplicate) {
        showAlert('A member with this email or mobile number already exists', 'danger');
        return;
    }
    
    if (editingId) {
        // Update existing member
        const memberIndex = temporaryMembers.findIndex(m => m.id === editingId);
        if (memberIndex !== -1) {
            temporaryMembers[memberIndex] = {
                id: editingId,
                name: name,
                mobile: formattedMobile,
                email: email,
                id_number: idNumber,
                role_id: roleId,
                role_name: roleName
            };
            showAlert(`${name}'s details updated successfully`, 'success');
        }
    } else {
        // Add new member to temporary members list
        const member = {
            id: 'temp_' + (++memberCounter),
            name: name,
            mobile: formattedMobile,
            email: email,
            id_number: idNumber,
            role_id: roleId,
            role_name: roleName
        };
        
        temporaryMembers.push(member);
        showAlert(`${name} added to the member list`, 'success');
    }
    
    updateMembersList();
    
    // Clear form and close modal
    resetMemberForm();
    const modal = bootstrap.Modal.getInstance(document.getElementById('exampleModal'));
    modal.hide();
}

function updateMembersList() {
    const memberList = document.getElementById('memberList');
    const emptyMessage = document.getElementById('emptyMessage');
    const membersCount = document.getElementById('membersCount');
    
    // Update count
    const countNumber = membersCount.querySelector('.count-number');
    countNumber.textContent = temporaryMembers.length;
    
    if (temporaryMembers.length === 0) {
        emptyMessage.style.display = 'flex';
        // Clear any existing member cards
        const existingCards = memberList.querySelectorAll('.member-card');
        existingCards.forEach(card => card.remove());
        return;
    }
    
    emptyMessage.style.display = 'none';
    
    // Clear existing member cards
    const existingCards = memberList.querySelectorAll('.member-card');
    existingCards.forEach(card => card.remove());
    
    // Add member cards
    temporaryMembers.forEach((member, index) => {
        const memberCard = document.createElement('div');
        memberCard.className = 'member-card';
        memberCard.innerHTML = `
            <div class="member-avatar">
                <i class='bx bx-user-circle'></i>
            </div>
            <div class="member-info">
                <h4 class="member-name">${member.name}</h4>
                <p class="member-role">${member.role_name}</p>
                <p class="member-contact">${member.mobile}</p>
            </div>
            <div class="member-actions">
                <button class="action-btn edit-btn" onclick="editMember('${member.id}')" title="Edit member">
                    <i class='bx bx-edit-alt'></i>
                </button>
                <button class="action-btn delete-btn" onclick="removeMember('${member.id}')" title="Remove member">
                    <i class='bx bx-trash-alt'></i>
                </button>
            </div>
        `;
        memberList.appendChild(memberCard);
    });
}

function removeMember(memberId) {
    temporaryMembers = temporaryMembers.filter(member => member.id !== memberId);
    updateMembersList();
    showAlert('Member removed from the list', 'info');
}

function editMember(memberId) {
    const member = temporaryMembers.find(m => m.id === memberId);
    if (!member) return;
    
    // Pre-fill the modal with member data
    document.getElementById('memberName').value = member.name;
    document.getElementById('memberEmail').value = member.email;
    document.getElementById('memberMobile').value = member.mobile;
    document.getElementById('memberIdNumber').value = member.id_number || '';
    document.getElementById('memberRole').value = member.role_id;
    
    // Store the member ID being edited
    document.getElementById('addMemberForm').dataset.editingId = memberId;
    
    // Change modal title and button text
    document.getElementById('exampleModalLabel').textContent = 'Edit Member';
    document.getElementById('addMemberBtn').innerHTML = '<i class="bx bx-check"></i> Update Member';
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('exampleModal'));
    modal.show();
}

function resetMemberForm() {
    // Reset form
    document.getElementById('addMemberForm').reset();
    delete document.getElementById('addMemberForm').dataset.editingId;
    
    // Reset modal title and button text
    document.getElementById('exampleModalLabel').textContent = 'Add Member to Group';
    document.getElementById('addMemberBtn').innerHTML = '<i class="bx bx-plus"></i> Add Member';
}

function createChama() {
    const form = document.getElementById('createChamaForm');
    const formData = new FormData(form);
    
    const name = formData.get('name').trim();
    const date = formData.get('date');
    const type = formData.get('type');
    
    // Validation
    if (!name || !date || !type) {
        showAlert('Please fill in all required fields', 'danger');
        return;
    }
    
    // Optional: Warn if no members are added
    if (temporaryMembers.length === 0) {
        if (!confirm('You are about to create a chama with no additional members. Only you will be added as the admin. Do you want to continue?')) {
            return;
        }
    }
    
    // Prepare data
    const data = {
        name: name,
        date: date,
        type: type,
        members: temporaryMembers
    };
    
    // Show loading state
    const createBtn = document.getElementById('createChamaBtn');
    const btnContent = createBtn.querySelector('.btn-content');
    const btnLoading = createBtn.querySelector('.btn-loading');
    
    btnContent.style.display = 'none';
    btnLoading.style.display = 'flex';
    createBtn.style.pointerEvents = 'none';
    
    // Submit chama creation
    fetch("{% url 'chamas:new-chama' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert(data.message, 'success');
            // Reset form and redirect
            setTimeout(() => {
                window.location.href = "{% url 'chamas:your-chamas' %}";
            }, 2000);
        } else {
            showAlert(data.message || 'An error occurred while creating the chama', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while creating the chama', 'danger');
    })
    .finally(() => {
        // Reset button state
        btnContent.style.display = 'flex';
        btnLoading.style.display = 'none';
        createBtn.style.pointerEvents = 'auto';
    });
}

function showAlert(message, type) {
    const alertCluster = document.getElementById('alertCluster');
    
    // Remove existing alerts
    alertCluster.innerHTML = '';
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show modern-alert`;
    alert.innerHTML = `
        <div class="alert-content">
            <i class='bx ${type === 'success' ? 'bx-check-circle' : type === 'danger' ? 'bx-error-circle' : type === 'warning' ? 'bx-warning' : 'bx-info-circle'}'></i>
            <span>${message}</span>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
            <i class='bx bx-x'></i>
        </button>
    `;
    
    alertCluster.appendChild(alert);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
    
    // Scroll to top to show alert
    alertCluster.scrollIntoView({ behavior: 'smooth' });
}
</script>

{%endblock%}