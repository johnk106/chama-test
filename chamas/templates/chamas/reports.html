{%extends 'chamas/base.html'%}
{%load static%}
{% load humanize %}
{%load custom_filters %}

{%block head%}
<title>Reports</title>
<link rel="stylesheet" href="{%static 'chamas/brand-colors.css'%}" />
<link rel="stylesheet" href="{%static 'chamas/reports.css'%}" />
{%endblock%}

{%block body%}
<div class="reports-container full-width">
    <!-- Page Header -->
    <div class="reports-header">
        <div class="reports-header-content">
            <h1 class="reports-title text-brand-primary">Financial Reports</h1>
            <p class="reports-subtitle">Generate, view, and download comprehensive financial reports</p>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel">
        <div class="filter-panel-header">
            <h3 class="text-brand-primary">Filter Reports</h3>
            <button type="button" class="btn-close-filter" id="closeFilterBtn">
                <i class='bx bx-x'></i>
            </button>
        </div>
        <div class="filter-panel-content">
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="global-start-date" class="filter-label">Start Date</label>
                    <input type="date" class="filter-input" id="global-start-date">
                </div>
                <div class="filter-group">
                    <label for="global-end-date" class="filter-label">End Date</label>
                    <input type="date" class="filter-input" id="global-end-date">
                </div>
                <div class="filter-group admin">
                    <label for="global-member-select" class="filter-label">Member</label>
                    <select class="filter-input" id="global-member-select">
                        <option value="">All Members</option>
                        {%for member in members%}
                        <option value="{{member.id}}">{{member.name}}</option>
                        {%endfor%}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="global-report-type" class="filter-label">Report Type</label>
                    <select class="filter-input" id="global-report-type">
                        <option value="">All Types</option>
                        <option value="cashflow">Cashflow</option>
                        <option value="loans">Loans</option>
                        <option value="investments">Investments</option>
                        <option value="savings">Savings</option>
                        <option value="contributions">Contributions</option>
                        <option value="fines">Fines</option>
                        <option value="expenses">Expenses</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button type="button" class="btn-primary" id="applyFiltersBtn">Apply Filters</button>
                <button type="button" class="btn-secondary" id="clearFiltersBtn">Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Reports Tabs Navigation -->
    <div class="reports-tabs-wrapper">
        <ul class="reports-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active admin member" id="cashflow-tab" data-bs-toggle="tab" href="#tab-cashflow" role="tab">
                    <i class="bx bx-trending-up"></i>
                    Cashflow
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="loans-tab" data-bs-toggle="tab" href="#tab-loans" role="tab">
                    <i class="bx bx-credit-card"></i>
                    Loans
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="investments-tab" data-bs-toggle="tab" href="#tab-investments" role="tab">
                    <i class="bx bx-trending-up"></i>
                    Investments
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="savings-tab" data-bs-toggle="tab" href="#tab-savings" role="tab">
                    <i class="bx bx-wallet"></i>
                    Savings
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="contributions-tab" data-bs-toggle="tab" href="#tab-contributions" role="tab">
                    <i class="bx bx-group"></i>
                    Contributions
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="fines-tab" data-bs-toggle="tab" href="#tab-fines" role="tab">
                    <i class="bx bx-receipt"></i>
                    Fines
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="expenses-tab" data-bs-toggle="tab" href="#tab-expenses" role="tab">
                    <i class="bx bx-receipt"></i>
                    Expenses
                </a>
            </li>
        </ul>
    </div>

    <!-- Tab Content -->
    <div class="reports-content">
        <div class="tab-content">
            <!-- Cashflow Tab -->
            <div class="tab-pane active" id="tab-cashflow" role="tabpanel">
                <div class="reports-grid">
                    <!-- Cashflow Report Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Cashflow Report</h3>
                                <p class="report-description">Overview of all cash inflows and outflows</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-chama-cashflow-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('cashflow-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="cashflow-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="cashflow-report-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="cashflow-report-start">
                                </div>
                                <div class="filter-field">
                                    <label for="cashflow-report-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="cashflow-report-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="cashflow-report-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No cashflow data available for the selected period</p>
                                </div>
                            </div>
                            <div id="cashflow-report-totals-cont" class="summary-cards"></div>
                            <div id="cashflow-report-net-cont" class="net-summary"></div>
                        </div>
                    </div>

                    <!-- Member Cashflow Report Card (Admin Only) -->
                    <div class="report-card brand-card admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Member Cashflow Report</h3>
                                <p class="report-description">Individual member cashflow analysis</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-member-cashflow-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('member-cashflow-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="member-cashflow-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="member-cashflow-owner" class="field-label">Select Member</label>
                                    <select class="field-input" id="member-cashflow-owner">
                                        <option value="" selected>All Members</option>
                                        {%for member in members%}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="member-cashflow-report-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="member-cashflow-report-start">
                                </div>
                                <div class="filter-field">
                                    <label for="member-cashflow-report-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="member-cashflow-report-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="member-cashflow-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-loader-alt bx-spin empty-state-icon"></i>
                                    <p class="empty-state-message">Loading...</p>
                                    <p class="empty-state-description">Loading member cashflow data</p>
                                </div>
                            </div>
                            <div id="member-cashflow-totals-cont" class="summary-cards">
                                <div class="summary-card">
                                    <h4 class="summary-title">Total Contributions</h4>
                                    <p class="summary-amount text-brand-primary">ksh {{total_contributions | intcomma}}</p>
                                </div>
                                <div class="summary-card">
                                    <h4 class="summary-title">Total Loan Disbursement</h4>
                                    <p class="summary-amount text-brand-primary">ksh {{total_loan_disbursment | intcomma}}</p>
                                </div>
                            </div>
                            <div id='member-cashflow-net-cont' class="net-summary"></div>
                        </div>
                    </div>

                    <!-- My Cashflow Report Card (Member Only) -->
                    <div class="report-card brand-card member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">My Cashflow Report</h3>
                                <p class="report-description">Your personal cashflow analysis</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-my-cashflow-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('my-cashflow-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="my-cashflow-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="my-reports-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="my-reports-start">
                                </div>
                                <div class="filter-field">
                                    <label for="my-reports-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="my-reports-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="my-report-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No personal cashflow data available for the selected period</p>
                                </div>
                            </div>
                            <div id="my-cashflow-report-totals-cont" class="summary-cards"></div>
                            <div id='my-cashflow-report-net-cont' class="net-summary"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loans Tab -->
            <div class="tab-pane" id="tab-loans" role="tabpanel">
                <div class="reports-grid">
                    <!-- Loan Report Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Loan Report</h3>
                                <p class="report-description">Comprehensive loan status overview</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-full-loan-report">
                                    <i class="bx bx-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div class="brand-table-responsive">
                                <table class="brand-table">
                                    <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Type</th>
                                            <th>Member</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {%for loan in loans%}
                                        <tr>
                                            <td><span class="status-badge {{loan.status}}">{{loan.status}}</span></td>
                                            <td>{{loan.type.name}}</td>
                                            <td>{{loan.member.name}}</td>
                                            <td class="text-brand-primary">ksh {{loan.amount | intcomma}}</td>
                                        </tr>
                                        {%empty%}
                                        <tr>
                                            <td colspan="4">
                                                <div class="empty-state">
                                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                                    <p class="empty-state-message">Nothing to show</p>
                                                    <p class="empty-state-description">No loans found</p>
                                                </div>
                                            </td>
                                        </tr>
                                        {%endfor%}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Repayment Schedule Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Repayment Schedule</h3>
                                <p class="report-description">Track loan repayment schedules and due dates</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-repayment-schedule">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('repayment-schedule')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="repayment-schedule-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="repayment-owner" class="field-label">Select Member</label>
                                    <select class="field-input" id="repayment-owner">
                                        <option value="" selected>All Members</option>
                                        {%for member in members %}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="repayment-start-date" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="repayment-start-date">
                                </div>
                                <div class="filter-field">
                                    <label for="repayment-end-date" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="repayment-end-date">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="repayment-schedule-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-loader-alt bx-spin empty-state-icon"></i>
                                    <p class="empty-state-message">Loading...</p>
                                    <p class="empty-state-description">Loading loan repayment schedule data</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Investments Tab -->
            <div class="tab-pane" id="tab-investments" role="tabpanel">
                <div class="reports-grid">
                    <!-- Group Investment Income Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Group Investment Income</h3>
                                <p class="report-description">Total investment returns for the group</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-group-investment-income">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('group-investment-income')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="group-investment-income-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="group-investment-incomes-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="group-investment-incomes-start">
                                </div>
                                <div class="filter-field">
                                    <label for="group-investment-incomes-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="group-investment-incomes-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="group-investment-incomes-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No group investment income data available for the selected period</p>
                                </div>
                            </div>
                            <div id="group-investment-incomes-total" class="summary-cards"></div>
                        </div>
                    </div>

                    <!-- Member Investment Income Card (Admin Only) -->
                    <div class="report-card brand-card admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Member Investment Income</h3>
                                <p class="report-description">Individual member investment returns</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-member-investment-income">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('member-investment-income')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="member-investment-income-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="investment-owner" class="field-label">Select Member</label>
                                    <select class="field-input" id="investment-owner">
                                        <option value="" disabled selected>Select Member</option>
                                        {%for member in members%}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="member-investment-incomes-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="member-investment-incomes-start">
                                </div>
                                <div class="filter-field">
                                    <label for="member-investment-incomes-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="member-investment-incomes-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="member-investment-income-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">Please select a member to view their investment income data</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My Investment Income Card (Member Only) -->
                    <div class="report-card brand-card member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">My Investment Income</h3>
                                <p class="report-description">Your personal investment returns</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-my-investment-income">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('my-investment-income')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="my-investment-income-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="my-incomes-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="my-incomes-start">
                                </div>
                                <div class="filter-field">
                                    <label for="my-incomes-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="my-incomes-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="my-income-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No personal investment income data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Savings Tab -->
            <div class="tab-pane" id="tab-savings" role="tabpanel">
                <div class="reports-grid">
                    <!-- Individual Savings Report Card -->
                    <div class="report-card brand-card member admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Individual Savings Report</h3>
                                <p class="report-description">Personal savings tracking and analysis</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-individual-saving-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('individual-saving-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="individual-saving-report-filters">
                            <div class="filter-row">
                                <div class="filter-field admin">
                                    <label for="saving-owner" class="field-label">Select Member</label>
                                    <select class="field-input" id="saving-owner">
                                        <option value="" disabled selected>Select Member</option>
                                        {%for member in members%}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="individual-saving-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="individual-saving-start">
                                </div>
                                <div class="filter-field">
                                    <label for="individual-saving-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="individual-saving-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="individual-saving-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">Please select a member to view their savings data</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Group Savings Report Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Group Savings Report</h3>
                                <p class="report-description">Combined group savings overview</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-group-saving-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('group-saving-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="group-saving-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="group-saving-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="group-saving-start">
                                </div>
                                <div class="filter-field">
                                    <label for="group-saving-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="group-saving-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="group-saving-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No group savings data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contributions Tab -->
            <div class="tab-pane" id="tab-contributions" role="tabpanel">
                <div class="reports-grid">
                    <!-- Group Contributions Card -->
                    <div class="report-card brand-card member admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Group Contributions</h3>
                                <p class="report-description">Member contribution tracking and analytics</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-group-contributions-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('group-contributions-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="group-contributions-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="group-contributions-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="group-contributions-start">
                                </div>
                                <div class="filter-field">
                                    <label for="group-contributions-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="group-contributions-end">
                                </div>
                                <div class="filter-field admin">
                                    <label for="member-contribution-owner-2" class="field-label">Select Member</label>
                                    <select class="field-input" id="member-contribution-owner-2">
                                        <option value="">All Members</option>
                                        {%for member in members%}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="member-contribution-scheme" class="field-label">Contribution Scheme</label>
                                    <select class="field-input" id="member-contribution-scheme">
                                        <option value="">All Schemes</option>
                                        {%for contribution in contributions%}
                                        <option value="{{contribution.id}}">{{contribution.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="group-contributions-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No group contributions data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My Contributions Card (Member Only) -->
                    <div class="report-card brand-card member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">My Contributions</h3>
                                <p class="report-description">Your personal contribution history</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-my-contributions-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('my-contributions-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="my-contributions-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="my-contributions-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="my-contributions-start">
                                </div>
                                <div class="filter-field">
                                    <label for="my-contributions-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="my-contributions-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="my-contributions-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No personal contribution history available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Member Contributions Card (Admin Only) -->
                    <div class="report-card brand-card admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Member Contributions</h3>
                                <p class="report-description">Individual member contribution details</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-member-contributions-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('member-contributions-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="member-contributions-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="member-contribution-owner" class="field-label">Select Member</label>
                                    <select class="field-input" id="member-contribution-owner">
                                        <option value="" disabled selected>Select Member</option>
                                        {%for member in members%}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="member-contributions-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="member-contributions-start">
                                </div>
                                <div class="filter-field">
                                    <label for="member-contributions-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="member-contributions-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="member-contributions-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No member contribution details available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fines Tab -->
            <div class="tab-pane" id="tab-fines" role="tabpanel">
                <div class="reports-grid">
                    <!-- Collected Fines Card -->
                    <div class="report-card brand-card member admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Collected Fines</h3>
                                <p class="report-description">Successfully collected fines and penalties</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-collected-fines-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('collected-fines-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="collected-fines-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="collected-fines-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="collected-fines-start">
                                </div>
                                <div class="filter-field">
                                    <label for="collected-fines-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="collected-fines-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="collected-fines-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No collected fines data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Unpaid Fines Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Unpaid Fines</h3>
                                <p class="report-description">Outstanding fines and penalties</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-unpaid-fines-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('unpaid-fines-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="unpaid-fines-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="unpaid-fines-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="unpaid-fines-start">
                                </div>
                                <div class="filter-field">
                                    <label for="unpaid-fines-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="unpaid-fines-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="unpaid-fines-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No unpaid fines data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div class="tab-pane" id="tab-expenses" role="tabpanel">
                <div class="reports-grid">
                    <!-- Expenses Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Expenses Report</h3>
                                <p class="report-description">Organizational expenses and expenditure tracking</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-expenses-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('expenses-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="expenses-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="expenses-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="expenses-start">
                                </div>
                                <div class="filter-field">
                                    <label for="expenses-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="expenses-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="expenses-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No expenses data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize Bootstrap tabs
    const tabTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tab"]'));
    tabTriggerList.map(function (tabTriggerEl) {
        return new bootstrap.Tab(tabTriggerEl);
    });

    // Individual report filter toggle
    window.toggleReportFilter = function(reportId) {
        const filterElement = document.getElementById(reportId + '-filters');
        if (filterElement) {
            filterElement.style.display = filterElement.style.display === 'none' ? 'block' : 'none';
        }
    };

    // Global filter functionality
    const globalFilterBtn = document.querySelector('.btn-filter-global');
    if (globalFilterBtn) {
        globalFilterBtn.addEventListener('click', function() {
            const filterPanel = document.getElementById('filterPanel');
            filterPanel.classList.toggle('active');
        });
    }

    // Keep all existing download functionality
    const downloadButtons = {
        '#download-full-loan-report': '/chamas-bookeeping/download-full-loan-report/',
        '#download-repayment-schedule': '/chamas-bookeeping/download-loan-repayment-schedule/',
        '#download-group-investment-income': '/chamas-bookeeping/download-group-investment-income/',
        '#download-member-investment-income': '/chamas-bookeeping/download-member-investment-income/',
        '#download-individual-saving-report': '/chamas-bookeeping/download-individual-saving-report/',
        '#download-group-saving-report': '/chamas-bookeeping/download-group-saving-report/',
        '#download-group-contributions-report': '/chamas-bookeeping/download-group-contributions-report/',
        '#download-expenses-report': '/chamas-bookeeping/download-expense-report/',
        '#download-member-contributions-report': '/chamas-bookeeping/download-member-contributions-report/',
        '#download-collected-fines-report': '/chamas-bookeeping/download-collected-fines-report/',
        '#download-unpaid-fines-report': '/chamas-bookeeping/download-uncollected-fines-report/',
        '#download-chama-cashflow-report': '/chamas-bookeeping/download-chama-cashflow-report/',
        '#download-member-cashflow-report': '/chamas-bookeeping/download-member-cashflow-report/',
        '#download-my-cashflow-report': '/chamas-bookeeping/download-my-cashflow-report/'
    };

    // Add download event listeners
    Object.entries(downloadButtons).forEach(([selector, baseUrl]) => {
        const button = document.querySelector(selector);
        if (button) {
            button.addEventListener('click', function () {
                const chama_id = localStorage.getItem('groupId');
                let url = `${baseUrl}${chama_id}/`;
                
                // Add member ID for specific reports
                if (selector.includes('member-') && !selector.includes('my-')) {
                    let memberId = null;
                    
                    // Get member ID based on report type
                    if (selector.includes('cashflow')) {
                        const memberSelect = document.querySelector('#member-cashflow-owner');
                        memberId = memberSelect?.value;
                        // For cashflow reports, we need a specific member selected
                        if (!memberId) {
                            alert('Please select a specific member to download their cashflow report');
                            return;
                        }
                    } else if (selector.includes('investment')) {
                        const memberSelect = document.querySelector('#investment-owner');
                        memberId = memberSelect?.value;
                    } else if (selector.includes('saving')) {
                        const memberSelect = document.querySelector('#saving-owner');
                        memberId = memberSelect?.value;
                    } else if (selector.includes('contribution')) {
                        const memberSelect = document.querySelector('#member-contribution-owner');
                        memberId = memberSelect?.value;
                    } else if (selector.includes('repayment')) {
                        const memberSelect = document.querySelector('#repayment-owner');
                        memberId = memberSelect?.value;
                    }
                    
                    // For member cashflow report, use the URL pattern with member_id
                    if (selector.includes('cashflow')) {
                        url = `${baseUrl}${chama_id}/${memberId}/`;
                    } else {
                        // For repayment schedule, member selection is optional
                        if (selector.includes('repayment')) {
                            if (memberId) {
                                url += `?member_id=${memberId}`;
                            }
                            // If no member selected, download all repayment schedules
                        } else {
                            // For other reports, member selection is required
                            if (memberId) {
                                url += `?member-id=${memberId}`;
                            } else {
                                alert('Please select a member first');
                                return;
                            }
                        }
                    }
                }

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `${selector.replace('#download-', '').replace('-', '_')}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => console.error('Error:', error));
            });
        }
    });
});

// Initialize report data from Django context
const reportData = {
    groupContributions: {% if group_contributions %}{{ group_contributions|safe }}{% else %}[]{% endif %},
    groupSavings: {% if group_saving_report %}{{ group_saving_report|safe }}{% else %}[]{% endif %},
    individualSavings: {% if individual_saving_report %}{{ individual_saving_report|safe }}{% else %}[]{% endif %},
    groupInvestmentIncomes: {% if group_investment_incomes %}{{ group_investment_incomes|safe }}{% else %}[]{% endif %},
    memberInvestmentIncomes: {% if member_investment_income %}{{ member_investment_income|safe }}{% else %}[]{% endif %},
    loans: {% if unpaid_loans %}{{ unpaid_loans|safe }}{% else %}[]{% endif %},
    collectedFines: {% if collected_fines %}{{ collected_fines|safe }}{% else %}[]{% endif %},
    unpaidFines: {% if unpaid_fines %}{{ unpaid_fines|safe }}{% else %}[]{% endif %},
    expenses: {% if chama_expense_reports %}{{ chama_expense_reports|safe }}{% else %}[]{% endif %},
    cashflow: {% if chama_cashflow_reports %}{{ chama_cashflow_reports|safe }}{% else %}[]{% endif %},
    myReports: {% if my_reports %}{{ my_reports|safe }}{% else %}[]{% endif %}
};

// Function to populate data containers
function populateReportData() {
    // Cashflow Report
    if (reportData.cashflow.length > 0) {
        const container = document.getElementById('cashflow-report-items');
        if (container) {
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Member</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.cashflow.map(item => `
                                <tr>
                                    <td><span class="status-badge">${item.type || 'N/A'}</span></td>
                                    <td>${item.member_id || 'Group'}</td>
                                    <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                    <td>${item.object_date || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // Group Investment Incomes
    if (reportData.groupInvestmentIncomes.length > 0) {
        const container = document.getElementById('group-investment-incomes-items');
        if (container) {
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                <th>Investment</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.groupInvestmentIncomes.map(item => `
                                <tr>
                                    <td>${item.investment_id || 'N/A'}</td>
                                    <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                    <td>${item.date || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // Individual Savings
    if (reportData.individualSavings.length > 0) {
        const container = document.getElementById('individual-saving-items');
        if (container) {
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Saving Type</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.individualSavings.map(item => `
                                <tr>
                                    <td>${item.owner_id || 'N/A'}</td>
                                    <td>${item.saving_type_id || 'N/A'}</td>
                                    <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                    <td>${item.date || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // Group Savings
    if (reportData.groupSavings.length > 0) {
        const container = document.getElementById('group-saving-items');
        if (container) {
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                <th>Saving Type</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.groupSavings.map(item => `
                                <tr>
                                    <td>${item.saving_type_id || 'Group Saving'}</td>
                                    <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                    <td>${item.date || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // Group Contributions
    if (reportData.groupContributions.length > 0) {
        const container = document.getElementById('group-contributions-items');
        if (container) {
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Scheme</th>
                                <th>Amount Paid</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.groupContributions.map(item => `
                                <tr>
                                    <td>${item.member_name || 'N/A'}</td>
                                    <td>${item.scheme_name || 'N/A'}</td>
                                    <td class="text-brand-primary">Ksh ${item.amount_paid?.toLocaleString() || '0'}</td>
                                    <td>${item.date_created || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // Collected Fines
    if (reportData.collectedFines.length > 0) {
        const container = document.getElementById('collected-fines-items');
        if (container) {
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.collectedFines.map(item => `
                                <tr>
                                    <td>${item.member || 'N/A'}</td>
                                    <td>${item.type || 'N/A'}</td>
                                    <td class="text-brand-primary">Ksh ${item.fine_amount?.toLocaleString() || '0'}</td>
                                    <td>${item.created || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // Unpaid Fines
    if (reportData.unpaidFines.length > 0) {
        const container = document.getElementById('unpaid-fines-items');
        if (container) {
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.unpaidFines.map(item => `
                                <tr>
                                    <td>${item.member || 'N/A'}</td>
                                    <td>${item.type || 'N/A'}</td>
                                    <td class="text-brand-primary">Ksh ${item.fine_amount?.toLocaleString() || '0'}</td>
                                    <td>${item.created || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // Expenses
    if (reportData.expenses.length > 0) {
        const container = document.getElementById('expenses-items');
        if (container) {
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                <th>Expense</th>
                                <th>Created By</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.expenses.map(item => `
                                <tr>
                                    <td>${item.name || 'N/A'}</td>
                                    <td>${item.created_by_id || 'N/A'}</td>
                                    <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                    <td>${item.created_on || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // My Reports (for cashflow)
    if (reportData.myReports.length > 0) {
        const container = document.getElementById('my-report-items');
        if (container) {
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.myReports.map(item => `
                                <tr>
                                    <td><span class="status-badge">${item.type || 'N/A'}</span></td>
                                    <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                    <td>${item.object_date || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // Member Investment Income
    if (reportData.memberInvestmentIncomes.length > 0) {
        const container = document.getElementById('member-investment-income-items');
        if (container) {
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                <th>Investment</th>
                                <th>Member</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.memberInvestmentIncomes.map(item => `
                                <tr>
                                    <td>${item.investment_id || 'N/A'}</td>
                                    <td>${item.owner_id || 'N/A'}</td>
                                    <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                    <td>${item.date || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // Add debug information to console for troubleshooting
    console.log('Report Data:', reportData);
}

// Initialize data when page loads
document.addEventListener('DOMContentLoaded', function() {
    populateReportData();
    
    // Load all member cashflow data initially
    filterMemberCashflow();
    
    // Load all loan repayment schedule data initially
    filterLoanRepaymentSchedule();
    
    // Add event listeners for filter interactions
    setupFilterListeners();
});

// Function to setup filter event listeners
function setupFilterListeners() {
    // Individual savings member selection
    const savingOwnerSelect = document.getElementById('saving-owner');
    if (savingOwnerSelect) {
        savingOwnerSelect.addEventListener('change', function() {
            if (this.value) {
                // Filter and show individual savings for selected member
                filterIndividualSavings(this.value);
            }
        });
    }

    // Investment owner selection
    const investmentOwnerSelect = document.getElementById('investment-owner');
    if (investmentOwnerSelect) {
        investmentOwnerSelect.addEventListener('change', function() {
            if (this.value) {
                filterMemberInvestmentIncome(this.value);
            }
        });
    }

    // Member cashflow selection
    const memberCashflowSelect = document.getElementById('member-cashflow-owner');
    if (memberCashflowSelect) {
        memberCashflowSelect.addEventListener('change', function() {
            const startDate = document.getElementById('member-cashflow-report-start')?.value;
            const endDate = document.getElementById('member-cashflow-report-end')?.value;
            // Pass null if no member is selected (empty value) to show all members
            const memberId = this.value || null;
            filterMemberCashflow(memberId, startDate, endDate);
        });
    }
    
    // Member cashflow date filters
    const memberCashflowStartDate = document.getElementById('member-cashflow-report-start');
    const memberCashflowEndDate = document.getElementById('member-cashflow-report-end');
    
    if (memberCashflowStartDate) {
        memberCashflowStartDate.addEventListener('change', function() {
            const memberId = document.getElementById('member-cashflow-owner')?.value || null;
            const endDate = document.getElementById('member-cashflow-report-end')?.value;
            // Always filter, even if no member is selected (will show all members with date filter)
            filterMemberCashflow(memberId, this.value, endDate);
        });
    }
    
    if (memberCashflowEndDate) {
        memberCashflowEndDate.addEventListener('change', function() {
            const memberId = document.getElementById('member-cashflow-owner')?.value || null;
            const startDate = document.getElementById('member-cashflow-report-start')?.value;
            // Always filter, even if no member is selected (will show all members with date filter)
                         filterMemberCashflow(memberId, startDate, this.value);
         });
     }
     
     // Loan repayment schedule selection
     const repaymentOwnerSelect = document.getElementById('repayment-owner');
     if (repaymentOwnerSelect) {
         repaymentOwnerSelect.addEventListener('change', function() {
             const startDate = document.getElementById('repayment-start-date')?.value;
             const endDate = document.getElementById('repayment-end-date')?.value;
             // Pass null if no member is selected (empty value) to show all members
             const memberId = this.value || null;
             filterLoanRepaymentSchedule(memberId, startDate, endDate);
         });
     }
     
     // Loan repayment schedule date filters
     const repaymentStartDate = document.getElementById('repayment-start-date');
     const repaymentEndDate = document.getElementById('repayment-end-date');
     
     if (repaymentStartDate) {
         repaymentStartDate.addEventListener('change', function() {
             const memberId = document.getElementById('repayment-owner')?.value || null;
             const endDate = document.getElementById('repayment-end-date')?.value;
             // Always filter, even if no member is selected (will show all members with date filter)
             filterLoanRepaymentSchedule(memberId, this.value, endDate);
         });
     }
     
     if (repaymentEndDate) {
         repaymentEndDate.addEventListener('change', function() {
             const memberId = document.getElementById('repayment-owner')?.value || null;
             const startDate = document.getElementById('repayment-start-date')?.value;
             // Always filter, even if no member is selected (will show all members with date filter)
             filterLoanRepaymentSchedule(memberId, startDate, this.value);
         });
     }
}

// Function to filter individual savings by member
function filterIndividualSavings(memberId) {
    const filteredSavings = reportData.individualSavings.filter(item => 
        item.owner_id == memberId || item.owner_id === memberId
    );
    
    const container = document.getElementById('individual-saving-items');
    if (container && filteredSavings.length > 0) {
        container.innerHTML = `
            <div class="brand-table-responsive">
                <table class="brand-table">
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Saving Type</th>
                            <th>Amount</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredSavings.map(item => `
                            <tr>
                                <td>${item.owner_id || 'N/A'}</td>
                                <td>${item.saving_type_id || 'N/A'}</td>
                                <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                <td>${item.date || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (container) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bx bx-file-blank empty-state-icon"></i>
                <p class="empty-state-message">No savings data found</p>
                <p class="empty-state-description">No savings data available for the selected member</p>
            </div>
        `;
    }
}

// Function to filter member investment income
function filterMemberInvestmentIncome(memberId) {
    const filteredIncomes = reportData.memberInvestmentIncomes.filter(item => 
        item.owner_id == memberId || item.owner_id === memberId
    );
    
    const container = document.getElementById('member-investment-income-items');
    if (container && filteredIncomes.length > 0) {
        container.innerHTML = `
            <div class="brand-table-responsive">
                <table class="brand-table">
                    <thead>
                        <tr>
                            <th>Investment</th>
                            <th>Member</th>
                            <th>Amount</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredIncomes.map(item => `
                            <tr>
                                <td>${item.investment_id || 'N/A'}</td>
                                <td>${item.owner_id || 'N/A'}</td>
                                <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                <td>${item.date || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (container) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bx bx-file-blank empty-state-icon"></i>
                <p class="empty-state-message">No investment income found</p>
                <p class="empty-state-description">No investment income data available for the selected member</p>
            </div>
        `;
    }
}

// Function to filter loan repayment schedule with AJAX call
function filterLoanRepaymentSchedule(memberId = null, startDate = null, endDate = null) {
    const container = document.getElementById('repayment-schedule-items');
    const chamaId = localStorage.getItem('groupId');
    
    // Show loading state
    if (container) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bx bx-loader-alt bx-spin empty-state-icon"></i>
                <p class="empty-state-message">Loading...</p>
                <p class="empty-state-description">Fetching loan repayment schedule data</p>
            </div>
        `;
    }
    
    // Build query parameters
    let params = new URLSearchParams();
    if (memberId) params.append('member_id', memberId);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    // Make AJAX request
    fetch(`/chamas-bookeeping/get-loan-repayment-schedule/${chamaId}/?${params.toString()}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.data.length > 0) {
            // Show member column if displaying all members (no specific member selected)
            const showMemberColumn = !memberId;
            
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                ${showMemberColumn ? '<th>Member</th>' : ''}
                                <th>Loan Type</th>
                                <th>Amount</th>
                                <th>Total to Pay</th>
                                <th>Balance</th>
                                <th>Monthly Payment</th>
                                <th>Next Due</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.data.map(item => `
                                <tr>
                                    ${showMemberColumn ? `<td>${item.member_name || 'N/A'}</td>` : ''}
                                    <td>${item.loan_type || 'N/A'}</td>
                                    <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                    <td class="text-brand-primary">Ksh ${item.total_amount_to_be_paid?.toLocaleString() || '0'}</td>
                                    <td class="text-brand-primary">Ksh ${item.balance?.toLocaleString() || '0'}</td>
                                    <td class="text-brand-primary">Ksh ${item.monthly_payment?.toLocaleString() || '0'}</td>
                                    <td>${item.next_due || 'N/A'}</td>
                                    <td><span class="status-badge ${item.status}">${item.status || 'N/A'}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Store current filtered data for download
            window.currentRepaymentScheduleData = {
                memberId: memberId,
                data: data.data,
                startDate: startDate,
                endDate: endDate
            };
        } else {
            const emptyMessage = memberId 
                ? `No loan repayment schedule available for the selected member${startDate || endDate ? ' in the specified date range' : ''}`
                : `No loan repayment schedule data available${startDate || endDate ? ' in the specified date range' : ''}`;
                
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bx bx-file-blank empty-state-icon"></i>
                    <p class="empty-state-message">No repayment schedule found</p>
                    <p class="empty-state-description">${emptyMessage}</p>
                </div>
            `;
            window.currentRepaymentScheduleData = null;
        }
    })
    .catch(error => {
        console.error('Error fetching loan repayment schedule:', error);
        container.innerHTML = `
            <div class="empty-state">
                <i class="bx bx-error empty-state-icon"></i>
                <p class="empty-state-message">Error loading data</p>
                <p class="empty-state-description">Failed to fetch repayment schedule data. Please try again.</p>
            </div>
        `;
        window.currentRepaymentScheduleData = null;
    });
}

// Function to filter member cashflow with AJAX call
function filterMemberCashflow(memberId = null, startDate = null, endDate = null) {
    const container = document.getElementById('member-cashflow-items');
    const chamaId = localStorage.getItem('groupId');
    
    // If no member is selected, we'll show all member cashflow data
    // This allows initial population of the table
    
    // Show loading state
    if (container) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bx bx-loader-alt bx-spin empty-state-icon"></i>
                <p class="empty-state-message">Loading...</p>
                <p class="empty-state-description">Fetching cashflow data for the selected member</p>
            </div>
        `;
    }
    
    // Build query parameters
    let params = new URLSearchParams();
    if (memberId) params.append('member_id', memberId);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    // Make AJAX request
    fetch(`/chamas-bookeeping/get-member-cashflow-data/${chamaId}/?${params.toString()}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.data.length > 0) {
            // Show member column if displaying all members (no specific member selected)
            const showMemberColumn = !memberId;
            
            container.innerHTML = `
                <div class="brand-table-responsive">
                    <table class="brand-table">
                        <thead>
                            <tr>
                                ${showMemberColumn ? '<th>Member</th>' : ''}
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.data.map(item => `
                                <tr>
                                    ${showMemberColumn ? `<td>${item.member_name || 'Group'}</td>` : ''}
                                    <td><span class="status-badge">${item.type || 'N/A'}</span></td>
                                    <td class="text-brand-primary">Ksh ${item.amount?.toLocaleString() || '0'}</td>
                                    <td>${item.object_date || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Store current filtered data for download
            window.currentMemberCashflowData = {
                memberId: memberId,
                data: data.data,
                startDate: startDate,
                endDate: endDate
            };
        } else {
            const emptyMessage = memberId 
                ? `No cashflow data available for the selected member${startDate || endDate ? ' in the specified date range' : ''}`
                : `No member cashflow data available${startDate || endDate ? ' in the specified date range' : ''}`;
                
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bx bx-file-blank empty-state-icon"></i>
                    <p class="empty-state-message">No cashflow data found</p>
                    <p class="empty-state-description">${emptyMessage}</p>
                </div>
            `;
            window.currentMemberCashflowData = null;
        }
    })
    .catch(error => {
        console.error('Error fetching member cashflow data:', error);
        container.innerHTML = `
            <div class="empty-state">
                <i class="bx bx-error empty-state-icon"></i>
                <p class="empty-state-message">Error loading data</p>
                <p class="empty-state-description">Failed to fetch cashflow data. Please try again.</p>
            </div>
        `;
        window.currentMemberCashflowData = null;
    });
}

// Function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{%endblock%}