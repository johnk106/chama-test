{%extends 'chamas/base.html'%}
{%load static%}
{% load humanize %}
{%load custom_filters %}

{%block head%}
<title>Reports</title>
<link rel="stylesheet" href="{%static 'chamas/brand-colors.css'%}" />
<link rel="stylesheet" href="{%static 'chamas/reports.css'%}" />
{%endblock%}

{%block body%}
<div class="reports-container full-width">
    <!-- Page Header -->
    <div class="reports-header">
        <div class="reports-header-content">
            <h1 class="reports-title text-brand-primary">Financial Reports</h1>
            <p class="reports-subtitle">Generate, view, and download comprehensive financial reports</p>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel">
        <div class="filter-panel-header">
            <h3 class="text-brand-primary">Filter Reports</h3>
            <button type="button" class="btn-close-filter" id="closeFilterBtn">
                <i class='bx bx-x'></i>
            </button>
        </div>
        <div class="filter-panel-content">
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="global-start-date" class="filter-label">Start Date</label>
                    <input type="date" class="filter-input" id="global-start-date">
                </div>
                <div class="filter-group">
                    <label for="global-end-date" class="filter-label">End Date</label>
                    <input type="date" class="filter-input" id="global-end-date">
                </div>
                <div class="filter-group admin">
                    <label for="global-member-select" class="filter-label">Member</label>
                    <select class="filter-input" id="global-member-select">
                        <option value="">All Members</option>
                        {%for member in members%}
                        <option value="{{member.id}}">{{member.name}}</option>
                        {%endfor%}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="global-report-type" class="filter-label">Report Type</label>
                    <select class="filter-input" id="global-report-type">
                        <option value="">All Types</option>
                        <option value="cashflow">Cashflow</option>
                        <option value="loans">Loans</option>
                        <option value="investments">Investments</option>
                        <option value="savings">Savings</option>
                        <option value="contributions">Contributions</option>
                        <option value="fines">Fines</option>
                        <option value="expenses">Expenses</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button type="button" class="btn-primary" id="applyFiltersBtn">Apply Filters</button>
                <button type="button" class="btn-secondary" id="clearFiltersBtn">Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Reports Tabs Navigation -->
    <div class="reports-tabs-wrapper">
        <ul class="reports-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active admin member" id="cashflow-tab" data-bs-toggle="tab" href="#tab-cashflow" role="tab">
                    <i class="bx bx-trending-up"></i>
                    Cashflow
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="loans-tab" data-bs-toggle="tab" href="#tab-loans" role="tab">
                    <i class="bx bx-credit-card"></i>
                    Loans
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="investments-tab" data-bs-toggle="tab" href="#tab-investments" role="tab">
                    <i class="bx bx-trending-up"></i>
                    Investments
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="savings-tab" data-bs-toggle="tab" href="#tab-savings" role="tab">
                    <i class="bx bx-wallet"></i>
                    Savings
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="contributions-tab" data-bs-toggle="tab" href="#tab-contributions" role="tab">
                    <i class="bx bx-group"></i>
                    Contributions
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="fines-tab" data-bs-toggle="tab" href="#tab-fines" role="tab">
                    <i class="bx bx-receipt"></i>
                    Fines
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link admin member" id="expenses-tab" data-bs-toggle="tab" href="#tab-expenses" role="tab">
                    <i class="bx bx-receipt"></i>
                    Expenses
                </a>
            </li>
        </ul>
    </div>

    <!-- Tab Content -->
    <div class="reports-content">
        <div class="tab-content">
            <!-- Cashflow Tab -->
            <div class="tab-pane active" id="tab-cashflow" role="tabpanel">
                <div class="reports-grid">
                    <!-- Cashflow Report Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Cashflow Report</h3>
                                <p class="report-description">Overview of all cash inflows and outflows</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-chama-cashflow-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('cashflow-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="cashflow-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="cashflow-report-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="cashflow-report-start">
                                </div>
                                <div class="filter-field">
                                    <label for="cashflow-report-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="cashflow-report-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="cashflow-report-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No cashflow data available for the selected period</p>
                                </div>
                            </div>
                            <div id="cashflow-report-totals-cont" class="summary-cards"></div>
                            <div id="cashflow-report-net-cont" class="net-summary"></div>
                        </div>
                    </div>

                    <!-- Member Cashflow Report Card (Admin Only) -->
                    <div class="report-card brand-card admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Member Cashflow Report</h3>
                                <p class="report-description">Individual member cashflow analysis</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-member-cashflow-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('member-cashflow-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="member-cashflow-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="member-cashflow-owner" class="field-label">Select Member</label>
                                    <select class="field-input" id="member-cashflow-owner">
                                        <option value="" disabled selected>Select Member</option>
                                        {%for member in members%}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="member-cashflow-report-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="member-cashflow-report-start">
                                </div>
                                <div class="filter-field">
                                    <label for="member-cashflow-report-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="member-cashflow-report-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="member-cashflow-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">Please select a member to view their cashflow data</p>
                                </div>
                            </div>
                            <div id="member-cashflow-totals-cont" class="summary-cards">
                                <div class="summary-card">
                                    <h4 class="summary-title">Total Contributions</h4>
                                    <p class="summary-amount text-brand-primary">ksh {{total_contributions | intcomma}}</p>
                                </div>
                                <div class="summary-card">
                                    <h4 class="summary-title">Total Loan Disbursement</h4>
                                    <p class="summary-amount text-brand-primary">ksh {{total_loan_disbursment | intcomma}}</p>
                                </div>
                            </div>
                            <div id='member-cashflow-net-cont' class="net-summary"></div>
                        </div>
                    </div>

                    <!-- My Cashflow Report Card (Member Only) -->
                    <div class="report-card brand-card member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">My Cashflow Report</h3>
                                <p class="report-description">Your personal cashflow analysis</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-my-cashflow-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('my-cashflow-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="my-cashflow-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="my-reports-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="my-reports-start">
                                </div>
                                <div class="filter-field">
                                    <label for="my-reports-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="my-reports-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="my-report-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No personal cashflow data available for the selected period</p>
                                </div>
                            </div>
                            <div id="my-cashflow-report-totals-cont" class="summary-cards"></div>
                            <div id='my-cashflow-report-net-cont' class="net-summary"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loans Tab -->
            <div class="tab-pane" id="tab-loans" role="tabpanel">
                <div class="reports-grid">
                    <!-- Loan Report Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Loan Report</h3>
                                <p class="report-description">Comprehensive loan status overview</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-full-loan-report">
                                    <i class="bx bx-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div class="brand-table-responsive">
                                <table class="brand-table">
                                    <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Type</th>
                                            <th>Member</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {%for loan in loans%}
                                        <tr>
                                            <td><span class="status-badge {{loan.status}}">{{loan.status}}</span></td>
                                            <td>{{loan.type.name}}</td>
                                            <td>{{loan.member.name}}</td>
                                            <td class="text-brand-primary">ksh {{loan.amount | intcomma}}</td>
                                        </tr>
                                        {%empty%}
                                        <tr>
                                            <td colspan="4">
                                                <div class="empty-state">
                                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                                    <p class="empty-state-message">Nothing to show</p>
                                                    <p class="empty-state-description">No loans found</p>
                                                </div>
                                            </td>
                                        </tr>
                                        {%endfor%}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Repayment Schedule Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Repayment Schedule</h3>
                                <p class="report-description">Track loan repayment schedules and due dates</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-repayment-schedule">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('repayment-schedule')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="repayment-schedule-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="repayment-owner" class="field-label">Select Member</label>
                                    <select class="field-input" id="repayment-owner">
                                        <option value="" disabled selected>Select Member</option>
                                        {%for member in members %}
                                        <option value="{{member.name}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="repayment-schedule-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">Please select a member to view their repayment schedule</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Investments Tab -->
            <div class="tab-pane" id="tab-investments" role="tabpanel">
                <div class="reports-grid">
                    <!-- Group Investment Income Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Group Investment Income</h3>
                                <p class="report-description">Total investment returns for the group</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-group-investment-income">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('group-investment-income')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="group-investment-income-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="group-investment-incomes-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="group-investment-incomes-start">
                                </div>
                                <div class="filter-field">
                                    <label for="group-investment-incomes-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="group-investment-incomes-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="group-investment-incomes-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No group investment income data available for the selected period</p>
                                </div>
                            </div>
                            <div id="group-investment-incomes-total" class="summary-cards"></div>
                        </div>
                    </div>

                    <!-- Member Investment Income Card (Admin Only) -->
                    <div class="report-card brand-card admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Member Investment Income</h3>
                                <p class="report-description">Individual member investment returns</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-member-investment-income">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('member-investment-income')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="member-investment-income-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="investment-owner" class="field-label">Select Member</label>
                                    <select class="field-input" id="investment-owner">
                                        <option value="" disabled selected>Select Member</option>
                                        {%for member in members%}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="member-investment-incomes-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="member-investment-incomes-start">
                                </div>
                                <div class="filter-field">
                                    <label for="member-investment-incomes-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="member-investment-incomes-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="member-investment-income-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">Please select a member to view their investment income data</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My Investment Income Card (Member Only) -->
                    <div class="report-card brand-card member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">My Investment Income</h3>
                                <p class="report-description">Your personal investment returns</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-my-investment-income">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('my-investment-income')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="my-investment-income-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="my-incomes-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="my-incomes-start">
                                </div>
                                <div class="filter-field">
                                    <label for="my-incomes-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="my-incomes-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="my-income-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No personal investment income data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Savings Tab -->
            <div class="tab-pane" id="tab-savings" role="tabpanel">
                <div class="reports-grid">
                    <!-- Individual Savings Report Card -->
                    <div class="report-card brand-card member admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Individual Savings Report</h3>
                                <p class="report-description">Personal savings tracking and analysis</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-individual-saving-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('individual-saving-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="individual-saving-report-filters">
                            <div class="filter-row">
                                <div class="filter-field admin">
                                    <label for="saving-owner" class="field-label">Select Member</label>
                                    <select class="field-input" id="saving-owner">
                                        <option value="" disabled selected>Select Member</option>
                                        {%for member in members%}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="individual-saving-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="individual-saving-start">
                                </div>
                                <div class="filter-field">
                                    <label for="individual-saving-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="individual-saving-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="individual-saving-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">Please select a member to view their savings data</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Group Savings Report Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Group Savings Report</h3>
                                <p class="report-description">Combined group savings overview</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-group-saving-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('group-saving-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="group-saving-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="group-saving-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="group-saving-start">
                                </div>
                                <div class="filter-field">
                                    <label for="group-saving-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="group-saving-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="group-saving-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No group savings data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contributions Tab -->
            <div class="tab-pane" id="tab-contributions" role="tabpanel">
                <div class="reports-grid">
                    <!-- Group Contributions Card -->
                    <div class="report-card brand-card member admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Group Contributions</h3>
                                <p class="report-description">Member contribution tracking and analytics</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-group-contributions-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('group-contributions-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="group-contributions-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="group-contributions-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="group-contributions-start">
                                </div>
                                <div class="filter-field">
                                    <label for="group-contributions-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="group-contributions-end">
                                </div>
                                <div class="filter-field admin">
                                    <label for="member-contribution-owner-2" class="field-label">Select Member</label>
                                    <select class="field-input" id="member-contribution-owner-2">
                                        <option value="">All Members</option>
                                        {%for member in members%}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="member-contribution-scheme" class="field-label">Contribution Scheme</label>
                                    <select class="field-input" id="member-contribution-scheme">
                                        <option value="">All Schemes</option>
                                        {%for contribution in contributions%}
                                        <option value="{{contribution.id}}">{{contribution.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="group-contributions-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No group contributions data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My Contributions Card (Member Only) -->
                    <div class="report-card brand-card member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">My Contributions</h3>
                                <p class="report-description">Your personal contribution history</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-my-contributions-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('my-contributions-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="my-contributions-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="my-contributions-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="my-contributions-start">
                                </div>
                                <div class="filter-field">
                                    <label for="my-contributions-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="my-contributions-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="my-contributions-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No personal contribution history available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Member Contributions Card (Admin Only) -->
                    <div class="report-card brand-card admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Member Contributions</h3>
                                <p class="report-description">Individual member contribution details</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-member-contributions-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('member-contributions-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="member-contributions-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="member-contribution-owner" class="field-label">Select Member</label>
                                    <select class="field-input" id="member-contribution-owner">
                                        <option value="" disabled selected>Select Member</option>
                                        {%for member in members%}
                                        <option value="{{member.id}}">{{member.name}}</option>
                                        {%endfor%}
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="member-contributions-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="member-contributions-start">
                                </div>
                                <div class="filter-field">
                                    <label for="member-contributions-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="member-contributions-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="member-contributions-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No member contribution details available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fines Tab -->
            <div class="tab-pane" id="tab-fines" role="tabpanel">
                <div class="reports-grid">
                    <!-- Collected Fines Card -->
                    <div class="report-card brand-card member admin">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Collected Fines</h3>
                                <p class="report-description">Successfully collected fines and penalties</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-collected-fines-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('collected-fines-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="collected-fines-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="collected-fines-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="collected-fines-start">
                                </div>
                                <div class="filter-field">
                                    <label for="collected-fines-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="collected-fines-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="collected-fines-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No collected fines data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Unpaid Fines Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Unpaid Fines</h3>
                                <p class="report-description">Outstanding fines and penalties</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-unpaid-fines-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('unpaid-fines-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="unpaid-fines-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="unpaid-fines-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="unpaid-fines-start">
                                </div>
                                <div class="filter-field">
                                    <label for="unpaid-fines-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="unpaid-fines-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="unpaid-fines-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No unpaid fines data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div class="tab-pane" id="tab-expenses" role="tabpanel">
                <div class="reports-grid">
                    <!-- Expenses Card -->
                    <div class="report-card brand-card admin member">
                        <div class="report-card-header brand-card-header">
                            <div class="report-header-info">
                                <h3 class="report-title text-brand-primary">Expenses Report</h3>
                                <p class="report-description">Organizational expenses and expenditure tracking</p>
                            </div>
                            <div class="report-actions">
                                <button class="btn-download-individual bg-brand-primary" id="download-expenses-report">
                                    <i class="bx bx-download"></i>
                                </button>
                                <button class="btn-filter-individual text-brand-primary" onclick="toggleReportFilter('expenses-report')">
                                    <i class="bx bx-filter"></i>
                                </button>
                            </div>
                        </div>
                        <div class="report-filters" id="expenses-report-filters">
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label for="expenses-start" class="field-label">Start Date</label>
                                    <input type="date" class="field-input" id="expenses-start">
                                </div>
                                <div class="filter-field">
                                    <label for="expenses-end" class="field-label">End Date</label>
                                    <input type="date" class="field-input" id="expenses-end">
                                </div>
                            </div>
                        </div>
                        <div class="report-data brand-card-body">
                            <div id="expenses-items" class="data-container">
                                <div class="empty-state">
                                    <i class="bx bx-file-blank empty-state-icon"></i>
                                    <p class="empty-state-message">Nothing to show</p>
                                    <p class="empty-state-description">No expenses data available for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize Bootstrap tabs
    const tabTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tab"]'));
    tabTriggerList.map(function (tabTriggerEl) {
        return new bootstrap.Tab(tabTriggerEl);
    });

    // Individual report filter toggle
    window.toggleReportFilter = function(reportId) {
        const filterElement = document.getElementById(reportId + '-filters');
        if (filterElement) {
            filterElement.style.display = filterElement.style.display === 'none' ? 'block' : 'none';
        }
    };

    // Global filter functionality
    const globalFilterBtn = document.querySelector('.btn-filter-global');
    if (globalFilterBtn) {
        globalFilterBtn.addEventListener('click', function() {
            const filterPanel = document.getElementById('filterPanel');
            filterPanel.classList.toggle('active');
        });
    }

    // Keep all existing download functionality
    const downloadButtons = {
        '#download-full-loan-report': '/chamas-bookeeping/download-full-loan-report/',
        '#download-repayment-schedule': '/chamas-bookeeping/download-loan-repayment-schedule/',
        '#download-group-investment-income': '/chamas-bookeeping/download-group-investment-income/',
        '#download-member-investment-income': '/chamas-bookeeping/download-member-investment-income/',
        '#download-individual-saving-report': '/chamas-bookeeping/download-individual-saving-report/',
        '#download-group-saving-report': '/chamas-bookeeping/download-group-saving-report/',
        '#download-group-contributions-report': '/chamas-bookeeping/download-group-contributions-report/',
        '#download-expenses-report': '/chamas-bookeeping/download-expense-report/',
        '#download-member-contributions-report': '/chamas-bookeeping/download-member-contributions-report/',
        '#download-collected-fines-report': '/chamas-bookeeping/download-collected-fines-report/',
        '#download-unpaid-fines-report': '/chamas-bookeeping/download-uncollected-fines-report/',
        '#download-chama-cashflow-report': '/chamas-bookeeping/download-chama-cashflow-report/',
        '#download-member-cashflow-report': '/chamas-bookeeping/download-member-cashflow-report/',
        '#download-my-cashflow-report': '/chamas-bookeeping/download-my-cashflow-report/'
    };

    // Add download event listeners
    Object.entries(downloadButtons).forEach(([selector, baseUrl]) => {
        const button = document.querySelector(selector);
        if (button) {
            button.addEventListener('click', function () {
                const chama_id = localStorage.getItem('groupId');
                let url = `${baseUrl}${chama_id}/`;
                
                // Add member ID for specific reports
                if (selector.includes('member-') && !selector.includes('my-')) {
                    const memberSelect = document.querySelector('#member-cashflow-owner, #investment-owner, #saving-owner, #member-contribution-owner');
                    if (memberSelect && memberSelect.value) {
                        url += `?member-id=${memberSelect.value}`;
                    }
                }

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `${selector.replace('#download-', '').replace('-', '_')}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => console.error('Error:', error));
            });
        }
    });
});

// Function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{%endblock%}