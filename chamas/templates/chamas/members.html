{% extends 'chamas/refined_base.html' %}
{% load static %}
{% load humanize %}

{% block head %}
<title>Members - {{ group.name }}</title>
<link rel="stylesheet" href="{% static 'chamas/brand-colors.css' %}">
<link rel="stylesheet" href="{% static 'chamas/members.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
/* Modern Members Page Styles */
.admin-members-container {
    padding: 2rem;
    background: var(--brand-gray-50);
    min-height: 100vh;
}

.admin-members-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 0 1rem;
}

.admin-members-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--brand-gray-900);
    margin: 0;
}

.admin-add-member {
    background: var(--brand-primary);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: var(--brand-border-radius-lg);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    box-shadow: var(--brand-shadow);
}

.admin-add-member:hover {
    background: var(--brand-primary-hover);
    transform: translateY(-2px);
    box-shadow: var(--brand-shadow-lg);
}

.admin-search-container {
    background: white;
    border-radius: var(--brand-border-radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--brand-shadow);
}

.admin-search-input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border: 2px solid var(--brand-gray-200);
    border-radius: var(--brand-border-radius);
    font-size: 1rem;
    transition: all 0.3s ease;
}

.admin-search-input:focus {
    outline: none;
    border-color: var(--brand-primary);
    box-shadow: 0 0 0 3px rgba(33, 145, 165, 0.1);
}

.admin-search-wrapper {
    position: relative;
}

.admin-search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--brand-gray-400);
}

.admin-members-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.admin-member-card {
    background: white;
    border-radius: var(--brand-border-radius-lg);
    padding: 1.5rem;
    box-shadow: var(--brand-shadow);
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.admin-member-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--brand-shadow-lg);
    border-color: var(--brand-primary);
}

.admin-member-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.admin-member-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid var(--brand-primary);
    flex-shrink: 0;
}

.admin-member-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.admin-member-info {
    flex: 1;
}

.admin-member-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--brand-gray-900);
    margin: 0 0 0.25rem 0;
}

.admin-member-role {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.admin-member-role.admin-bulb {
    background: var(--brand-primary);
    color: white;
}

.admin-member-role.member-bulb {
    background: var(--brand-success);
    color: white;
}

.admin-member-role.treasurer-bulb {
    background: var(--brand-warning);
    color: white;
}

.admin-member-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.admin-remove-member {
    background: var(--brand-error);
    color: white;
    border: none;
    padding: 0.5rem;
    border-radius: var(--brand-border-radius);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0.7;
    transform: scale(0.9);
    min-width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.admin-member-card:hover .admin-remove-member {
    opacity: 1;
    transform: scale(1);
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
}

.admin-remove-member:hover {
    background: #dc2626;
    transform: scale(1.05);
}

.admin-remove-member:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    opacity: 0.3;
}

.admin-remove-member:disabled:hover {
    background: #9ca3af;
    transform: scale(0.9);
    box-shadow: none;
}

/* Add visual indication for creator protection */
.admin-member-card[data-is-creator="true"] .admin-remove-member {
    background: #9ca3af;
    cursor: not-allowed;
    opacity: 0.3;
}

.admin-member-card[data-is-creator="true"] .admin-remove-member::after {
    content: "Creator";
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.6rem;
    color: #6b7280;
    white-space: nowrap;
}

.admin-member-stats {
    display: flex;
    justify-content: space-between;
    padding-top: 1rem;
    border-top: 1px solid var(--brand-gray-200);
}

.admin-stat-item {
    text-align: center;
}

.admin-stat-label {
    display: block;
    font-size: 0.75rem;
    color: var(--brand-gray-500);
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.admin-stat-value {
    display: block;
    font-size: 1rem;
    font-weight: 700;
    color: var(--brand-gray-900);
}

/* Modal Styles */
.admin-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    opacity: 0;
    transition: all 0.3s ease;
}

.admin-modal.active {
    display: flex;
    opacity: 1;
    justify-content: center;
    align-items: center;
    padding: 2rem;
}

.admin-modal-content {
    background: white;
    border-radius: var(--brand-border-radius-lg);
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--brand-shadow-lg);
    transform: scale(0.9);
    transition: all 0.3s ease;
}

.admin-modal.active .admin-modal-content {
    transform: scale(1);
}

.admin-modal-header {
    padding: 2rem 2rem 1rem;
    border-bottom: 1px solid var(--brand-gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--brand-gray-900);
    margin: 0;
}

.admin-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--brand-gray-400);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: var(--brand-border-radius);
    transition: all 0.3s ease;
}

.admin-modal-close:hover {
    background: var(--brand-gray-100);
    color: var(--brand-gray-600);
}

.admin-modal-body {
    padding: 2rem;
}

.admin-member-details {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.admin-member-profile {
    text-align: center;
}

.admin-member-profile .admin-member-avatar {
    width: 120px;
    height: 120px;
    margin: 0 auto 1rem;
}

.admin-contact-info {
    background: var(--brand-gray-50);
    padding: 1.5rem;
    border-radius: var(--brand-border-radius);
}

.admin-contact-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.admin-contact-item:last-child {
    margin-bottom: 0;
}

.admin-contact-icon {
    width: 20px;
    color: var(--brand-primary);
}

.admin-records-section {
    margin-top: 2rem;
}

.admin-records-tabs {
    display: flex;
    border-bottom: 1px solid var(--brand-gray-200);
    margin-bottom: 1.5rem;
}

.admin-tab-button {
    background: none;
    border: none;
    padding: 1rem 1.5rem;
    font-weight: 600;
    color: var(--brand-gray-500);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
}

.admin-tab-button.active {
    color: var(--brand-primary);
    border-bottom-color: var(--brand-primary);
}

.admin-tab-content {
    display: none;
}

.admin-tab-content.active {
    display: block;
}

.admin-records-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-records-table th,
.admin-records-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--brand-gray-200);
}

.admin-records-table th {
    background: var(--brand-gray-50);
    font-weight: 600;
    color: var(--brand-gray-700);
}

.admin-empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--brand-gray-500);
}

.admin-empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.admin-pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
}

.admin-page-btn {
    background: white;
    border: 1px solid var(--brand-gray-300);
    padding: 0.5rem 0.75rem;
    border-radius: var(--brand-border-radius);
    cursor: pointer;
    transition: all 0.3s ease;
}

.admin-page-btn:hover,
.admin-page-btn.active {
    background: var(--brand-primary);
    color: white;
    border-color: var(--brand-primary);
}

/* Responsive Design */
@media (max-width: 768px) {
    .admin-members-container {
        padding: 1rem;
    }
    
    .admin-members-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .admin-members-grid {
        grid-template-columns: 1fr;
    }
    
    .admin-member-details {
        grid-template-columns: 1fr;
    }
    
    .admin-modal-content {
        margin: 1rem;
        max-height: calc(100vh - 2rem);
    }
    
    .admin-modal-body {
        padding: 1rem;
    }
    
    .admin-records-tabs {
        flex-wrap: wrap;
    }
    
    .admin-tab-button {
        flex: 1;
        min-width: 120px;
    }
}

/* Alert Styles */
.admin-alert {
    padding: 1rem;
    border-radius: var(--brand-border-radius);
    margin-bottom: 1rem;
    font-weight: 500;
}

.admin-alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.admin-alert-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
}

.admin-alert-warning {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
}

/* Loading State */
.admin-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 3rem;
}

.admin-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--brand-gray-200);
    border-top: 4px solid var(--brand-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Status Badges */
.status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.status-paid {
    background: #d1fae5;
    color: #065f46;
}

.status-partial {
    background: #fef3c7;
    color: #92400e;
}

.status-pending {
    background: #fee2e2;
    color: #991b1b;
}

.status-active {
    background: #dbeafe;
    color: #1e40af;
}

.status-application {
    background: #f3e8ff;
    color: #7c3aed;
}
</style>
{% endblock %}

{% block body %}
<!-- Debug Information -->
{% if debug %}
<div style="background: #f0f0f0; padding: 10px; margin: 10px; border-radius: 5px; font-family: monospace;">
    <strong>DEBUG:</strong> Chama: {{ group.name }}, Members: {{ members_count }}, Roles: {{ roles.count }}
</div>
{% endif %}

<!-- CSRF Token for AJAX calls -->
{% csrf_token %}

<div class="admin-members-container" data-chama-id="{{ chama_id }}">
    <!-- Header Section -->
    <div class="admin-members-header">
        <h1 class="admin-members-title">
            <i class="fas fa-users"></i>
            Members ({{ members_count|default:0 }})
        </h1>
        <button class="admin admin-add-member" onclick="openAddMemberModal()">
            <i class="fas fa-plus"></i>
            Add Member
        </button>
    </div>

    <!-- Alerts -->
    <div id="admin-alerts-container">
        <!-- Alerts will be dynamically inserted here -->
    </div>
    


    <!-- Search Section -->
    <div class="admin-search-container">
        <div class="admin-search-wrapper">
            <i class="fas fa-search admin-search-icon"></i>
            <input 
                type="text" 
                class="admin-search-input" 
                placeholder="Search members by name, email, or phone..."
                id="adminMemberSearch"
                onkeyup="filterMembers()"
            >
        </div>
    </div>

    <!-- Members Grid -->
    <div class="admin-members-grid" id="adminMembersGrid">
        {% for member in members %}
        <div class="admin-member-card" 
             data-member-id="{{ member.id }}" 
             data-member-name="{{ member.name }}"
             data-member-email="{{ member.email }}"
             data-member-mobile="{{ member.mobile }}"
             data-is-creator="{% if member.user and member.user == group.created_by %}true{% else %}false{% endif %}"
             onclick="openMemberModal({{ member.id }})">
            <div class="admin-member-header">
                <div class="admin-member-avatar">
                    {% if member.profile %}
                        <img src="{{ member.profile }}" alt="{{ member.name }}" loading="lazy">
                    {% else %}
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNGM0Y0RjYiLz4KPGNpcmNsZSBjeD0iMzAiIGN5PSIyMiIgcj0iMTAiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTEwIDUwQzEwIDQwLjMzNTkgMTcuMTYzNCAzMi41IDI2IDMyLjVIMzRDNDIuODM2NiAzMi41IDUwIDQwLjMzNTkgNTAgNTBWNTBIMTBWNTBaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=" alt="Default Avatar">
                    {% endif %}
                </div>
                <div class="admin-member-info">
                    <h3 class="admin-member-name">{{ member.name|title }}</h3>
                    <span class="admin-member-role {{ member.role.name|lower }}-bulb">
                        {{ member.role.name|title }}
                    </span>
                </div>
                <div class="admin-member-actions">
                    <button class="admin admin-remove-member" 
                            onclick="event.stopPropagation(); confirmRemoveMember({{ member.id }}, '{{ member.name|escapejs }}')" 
                            title="{% if member.user and member.user == group.created_by %}Cannot remove chama creator{% else %}Remove {{ member.name }} from chama{% endif %}"
                            {% if member.user and member.user == group.created_by %}disabled style="opacity: 0.3; cursor: not-allowed;"{% endif %}>
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="admin-member-stats">
                <div class="admin-stat-item">
                    <span class="admin-stat-label">Contributions</span>
                    <span class="admin-stat-value">KSh {{ member.total_contributions|floatformat:0|intcomma|default:"0" }}</span>
                </div>
                <div class="admin-stat-item">
                    <span class="admin-stat-label">Loans</span>
                    <span class="admin-stat-value">{{ member.total_loans|default:"0" }}</span>
                </div>
                <div class="admin-stat-item">
                    <span class="admin-stat-label">Since</span>
                    <span class="admin-stat-value">{{ member.member_since|date:"M Y" }}</span>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="admin-empty-state">
            <div class="admin-empty-icon">
                <i class="fas fa-users"></i>
            </div>
            <h3>No Members Found</h3>
            <p>Start by adding your first member to the chama.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="admin-pagination" id="adminPagination">
        <!-- Pagination will be generated by JavaScript -->
    </div>
</div>

<!-- Member Details Modal -->
<div class="modal admin-modal" id="adminMemberModal" role="dialog" aria-labelledby="memberModalTitle" aria-hidden="true">
    <div class="admin-modal-content" role="document">
        <div class="admin-modal-header">
            <h2 class="admin-modal-title" id="memberModalTitle">Member Details</h2>
            <button class="admin-modal-close" onclick="closeMemberModal()" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="admin-modal-body" id="adminMemberModalBody">
            <div class="admin-loading">
                <div class="admin-spinner"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div class="modal admin-modal" id="adminAddMemberModal" role="dialog" aria-labelledby="addMemberModalTitle" aria-hidden="true">
    <div class="admin-modal-content" role="document">
        <div class="admin-modal-header">
            <h2 class="admin-modal-title" id="addMemberModalTitle">Add New Member</h2>
            <button class="admin-modal-close" onclick="closeAddMemberModal()" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="admin-modal-body">
            <form id="adminAddMemberForm" onsubmit="submitAddMember(event)">
                <div style="margin-bottom: 1rem;">
                    <label for="memberName" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Full Name</label>
                    <input type="text" id="memberName" name="name" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--brand-gray-200); border-radius: var(--brand-border-radius);">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="memberEmail" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email</label>
                    <input type="email" id="memberEmail" name="email" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--brand-gray-200); border-radius: var(--brand-border-radius);">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="memberPhone" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Phone Number</label>
                    <input type="tel" id="memberPhone" name="mobile" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--brand-gray-200); border-radius: var(--brand-border-radius);">
                </div>
                <div style="margin-bottom: 2rem;">
                    <label for="memberRole" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Role</label>
                    <select id="memberRole" name="role" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--brand-gray-200); border-radius: var(--brand-border-radius);">
                        <option value="">Select a role</option>
                        {% for role in roles %}
                        <option value="{{ role.id }}">{{ role.name|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="closeAddMemberModal()" style="padding: 0.75rem 1.5rem; border: 1px solid var(--brand-gray-300); background: white; border-radius: var(--brand-border-radius); cursor: pointer;">Cancel</button>
                    <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--brand-primary); color: white; border: none; border-radius: var(--brand-border-radius); cursor: pointer;">Add Member</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global variables
let currentPage = 1;
const membersPerPage = 12;
let filteredMembers = [];
let allMembers = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeMembers();
    setupEventListeners();
});

function initializeMembers() {
    const memberCards = document.querySelectorAll('.admin-member-card');
    allMembers = Array.from(memberCards);
    filteredMembers = [...allMembers];
    updatePagination();
}

function setupEventListeners() {
    // Modal click outside to close
    document.getElementById('adminMemberModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeMemberModal();
        }
    });
    
    document.getElementById('adminAddMemberModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddMemberModal();
        }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeMemberModal();
            closeAddMemberModal();
        }
    });
}

function filterMembers() {
    const searchTerm = document.getElementById('adminMemberSearch').value.toLowerCase();
    
    filteredMembers = allMembers.filter(card => {
        const name = card.querySelector('.admin-member-name').textContent.toLowerCase();
        const email = card.dataset.memberEmail ? card.dataset.memberEmail.toLowerCase() : '';
        const mobile = card.dataset.memberMobile ? card.dataset.memberMobile.toLowerCase() : '';
        
        return name.includes(searchTerm) || 
               email.includes(searchTerm) || 
               mobile.includes(searchTerm);
    });
    
    currentPage = 1;
    updatePagination();
    displayMembers();
}

function displayMembers() {
    const start = (currentPage - 1) * membersPerPage;
    const end = start + membersPerPage;
    
    allMembers.forEach(card => {
        card.style.display = 'none';
    });
    
    filteredMembers.slice(start, end).forEach(card => {
        card.style.display = 'block';
    });
}

function updatePagination() {
    const totalPages = Math.ceil(filteredMembers.length / membersPerPage);
    const paginationContainer = document.getElementById('adminPagination');
    
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        displayMembers();
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    if (currentPage > 1) {
        paginationHTML += `<button class="admin-page-btn" onclick="changePage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>`;
    }
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            paginationHTML += `<button class="admin-page-btn active">${i}</button>`;
        } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHTML += `<button class="admin-page-btn" onclick="changePage(${i})">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHTML += `<span class="admin-page-btn">...</span>`;
        }
    }
    
    // Next button
    if (currentPage < totalPages) {
        paginationHTML += `<button class="admin-page-btn" onclick="changePage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>`;
    }
    
    paginationContainer.innerHTML = paginationHTML;
    displayMembers();
}

function changePage(page) {
    currentPage = page;
    updatePagination();
}

function openMemberModal(memberId) {
    const modal = document.getElementById('adminMemberModal');
    const modalBody = document.getElementById('adminMemberModalBody');
    
    // Show loading state
    modalBody.innerHTML = `
        <div class="admin-loading">
            <div class="admin-spinner"></div>
        </div>
    `;
    
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    
    // Focus trap
    const closeBtn = modal.querySelector('.admin-modal-close');
    closeBtn.focus();
    
    // Fetch member details (simulate API call)
    setTimeout(() => {
        loadMemberDetails(memberId);
    }, 500);
}

function loadMemberDetails(memberId) {
    const modalBody = document.getElementById('adminMemberModalBody');
    const chamaId = document.querySelector('.admin-members-container').dataset.chamaId;
    
    // Validate required parameters
    if (!memberId || !chamaId) {
        modalBody.innerHTML = `
            <div class="admin-empty-state">
                <div class="admin-empty-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Error Loading Member Details</h3>
                <p>Missing required parameters</p>
            </div>
        `;
        return;
    }
    
    const url = `/chamas-bookeeping/member-detail/${memberId}/${chamaId}/`;
    
    // Make AJAX call to get detailed member data
    fetch(url, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            renderMemberDetails(data);
        } else {
            throw new Error(data.message || 'Failed to load member details');
        }
    })
    .catch(error => {
        console.error('Failed to load member details:', error);
        modalBody.innerHTML = `
            <div class="admin-empty-state">
                <div class="admin-empty-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Error Loading Member Details</h3>
                <p>${error.message}</p>
                <button onclick="loadMemberDetails(${memberId})" class="admin-add-member" style="margin-top: 1rem;">
                    <i class="fas fa-retry"></i> Try Again
                </button>
            </div>
        `;
    });
}

function renderMemberDetails(data) {
    const modalBody = document.getElementById('adminMemberModalBody');
    const member = data.member;
    
    // Update modal title
    document.getElementById('memberModalTitle').textContent = `${member.name} - Member Details`;
    
    modalBody.innerHTML = `
        <div class="admin-member-details">
            <div class="admin-member-profile">
                <div class="admin-member-avatar">
                    <img src="${member.profile || getDefaultAvatar()}" alt="${member.name}">
                </div>
                <h3>${member.name}</h3>
                <span class="admin-member-role ${member.role.toLowerCase()}-bulb">${member.role}</span>
                <p style="margin-top: 0.5rem; color: var(--brand-gray-600);">
                    ${member.member_id ? `ID: ${member.member_id}` : 'No ID assigned'}
                </p>
            </div>
            <div class="admin-contact-info">
                <h4 style="margin-bottom: 1rem;">Contact Information</h4>
                <div class="admin-contact-item">
                    <i class="fas fa-envelope admin-contact-icon"></i>
                    <span>${member.email}</span>
                </div>
                <div class="admin-contact-item">
                    <i class="fas fa-phone admin-contact-icon"></i>
                    <span>${member.mobile}</span>
                </div>
                <div class="admin-contact-item">
                    <i class="fas fa-calendar admin-contact-icon"></i>
                    <span>Member since: ${member.member_since}</span>
                </div>
                <div class="admin-contact-item">
                    <i class="fas fa-chart-line admin-contact-icon"></i>
                    <span>Total Contributions: KSh ${formatCurrency(member.total_contributions)}</span>
                </div>
                <div class="admin-contact-item">
                    <i class="fas fa-hand-holding-usd admin-contact-icon"></i>
                    <span>Active Loans: ${member.total_loans}</span>
                </div>
                <div class="admin-contact-item">
                    <i class="fas fa-exclamation-triangle admin-contact-icon"></i>
                    <span>Outstanding Fines: KSh ${formatCurrency(member.total_fines)}</span>
                </div>
            </div>
        </div>
        
        <div class="admin-records-section">
            <div class="admin-records-tabs">
                <button class="admin-tab-button active" onclick="switchTab('contributions')">
                    Contributions (${data.contributions.length})
                </button>
                <button class="admin-tab-button" onclick="switchTab('loans')">
                    Loans (${data.loans.length})
                </button>
                <button class="admin-tab-button" onclick="switchTab('fines')">
                    Fines (${data.fines.length})
                </button>
            </div>
            
            <div id="contributions-tab" class="admin-tab-content active">
                ${renderContributionsTable(data.contributions)}
            </div>
            
            <div id="loans-tab" class="admin-tab-content">
                ${renderLoansTable(data.loans)}
            </div>
            
            <div id="fines-tab" class="admin-tab-content">
                ${renderFinesTable(data.fines)}
            </div>
        </div>
    `;
}

function renderContributionsTable(contributions) {
    if (contributions.length === 0) {
        return `
            <div class="admin-empty-state">
                <div class="admin-empty-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3>No Contribution Records</h3>
                <p>This member has no contribution records yet.</p>
            </div>
        `;
    }
    
    const rows = contributions.map(contrib => `
        <tr>
            <td>${contrib.date_created}</td>
            <td>${contrib.contribution_name}</td>
            <td>KSh ${formatCurrency(contrib.amount_paid)} / KSh ${formatCurrency(contrib.amount_expected)}</td>
            <td><span class="status-badge status-${contrib.status.toLowerCase()}">${contrib.status}</span></td>
        </tr>
    `).join('');
    
    return `
        <table class="admin-records-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Contribution Type</th>
                    <th>Amount (Paid/Expected)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${rows}
            </tbody>
        </table>
    `;
}

function renderLoansTable(loans) {
    if (loans.length === 0) {
        return `
            <div class="admin-empty-state">
                <div class="admin-empty-icon">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
                <h3>No Loan Records</h3>
                <p>This member has no loan records yet.</p>
            </div>
        `;
    }
    
    const rows = loans.map(loan => `
        <tr>
            <td>${loan.start_date}</td>
            <td>${loan.loan_type}</td>
            <td>KSh ${formatCurrency(loan.amount)}</td>
            <td>KSh ${formatCurrency(loan.balance)}</td>
            <td><span class="status-badge status-${loan.status.toLowerCase()}">${loan.status}</span></td>
        </tr>
    `).join('');
    
    return `
        <table class="admin-records-table">
            <thead>
                <tr>
                    <th>Start Date</th>
                    <th>Loan Type</th>
                    <th>Amount</th>
                    <th>Balance</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${rows}
            </tbody>
        </table>
    `;
}

function renderFinesTable(fines) {
    if (fines.length === 0) {
        return `
            <div class="admin-empty-state">
                <div class="admin-empty-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>No Fine Records</h3>
                <p>This member has no fine records.</p>
            </div>
        `;
    }
    
    const rows = fines.map(fine => `
        <tr>
            <td>${fine.created}</td>
            <td>${fine.fine_type}</td>
            <td>KSh ${formatCurrency(fine.fine_amount)}</td>
            <td>KSh ${formatCurrency(fine.fine_balance)}</td>
            <td><span class="status-badge status-${fine.status.toLowerCase()}">${fine.status}</span></td>
        </tr>
    `).join('');
    
    return `
        <table class="admin-records-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Fine Type</th>
                    <th>Amount</th>
                    <th>Balance</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${rows}
            </tbody>
        </table>
    `;
}

function switchTab(tabName) {
    // Remove active class from all tabs and contents
    document.querySelectorAll('.admin-tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.admin-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Add active class to selected tab and content
    event.target.classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
}

function closeMemberModal() {
    const modal = document.getElementById('adminMemberModal');
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
}

function openAddMemberModal() {
    const modal = document.getElementById('adminAddMemberModal');
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    
    // Focus on first input
    document.getElementById('memberName').focus();
}

function closeAddMemberModal() {
    const modal = document.getElementById('adminAddMemberModal');
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
    
    // Reset form
    document.getElementById('adminAddMemberForm').reset();
}

function submitAddMember(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const memberData = Object.fromEntries(formData.entries());
    const chamaId = document.querySelector('.admin-members-container').dataset.chamaId;
    
    // Add chama_id to the member data
    memberData.chama_id = chamaId;
    
    // Show loading state
    const submitBtn = event.target.querySelector('[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Adding...';
    submitBtn.disabled = true;
    

    
    // Validate required fields
    if (!memberData.name || !memberData.email || !memberData.mobile || !memberData.role || !chamaId) {
        const missingFields = [];
        if (!memberData.name) missingFields.push('name');
        if (!memberData.email) missingFields.push('email');
        if (!memberData.mobile) missingFields.push('mobile');
        if (!memberData.role) missingFields.push('role');
        if (!chamaId) missingFields.push('chama_id');
        
        showAlert(`Missing required fields: ${missingFields.join(', ')}`, 'error');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
    }
    
    const url = '/chamas-bookeeping/add-member/';
    
    // Make AJAX call to add member
    fetch(url, {
        method: 'POST',
        body: JSON.stringify(memberData),
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        // Handle both success and error responses
        return response.json().then(data => {
            if (response.ok && data.status === 'success') {
                showAlert(data.message, 'success');
                closeAddMemberModal();
                
                // Refresh the page to show the new member
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                // Handle error responses (400, 500, etc.)
                const errorMessage = data.message || `Server error: ${response.status}`;
                throw new Error(errorMessage);
            }
        });
    })
    .catch(error => {
        console.error('Failed to add member:', error);
        
        // Show more specific error message
        let errorMessage = error.message;
        if (errorMessage.includes('Failed to fetch')) {
            errorMessage = 'Network error: Could not connect to server';
        }
        
        showAlert(errorMessage, 'error');
    })
    .finally(() => {
        // Reset button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

function confirmRemoveMember(memberId, memberName) {
    // Enhanced confirmation dialog with more information
    const confirmMessage = `⚠️ Remove Member Confirmation\n\n` +
                          `Member: ${memberName}\n` +
                          `Action: Remove from chama\n\n` +
                          `This will:\n` +
                          `• Deactivate the member's account\n` +
                          `• Preserve their transaction history\n` +
                          `• Prevent them from accessing the chama\n\n` +
                          `This action cannot be undone.\n\n` +
                          `Are you sure you want to proceed?`;
    
    if (confirm(confirmMessage)) {
        removeMember(memberId, memberName);
    }
}

function removeMember(memberId, memberName = 'Unknown Member') {
    const memberCard = document.querySelector(`[data-member-id="${memberId}"]`);
    const chamaId = document.querySelector('.admin-members-container').dataset.chamaId;
    
    // Validate required parameters
    if (!memberId || !chamaId) {
        console.error('Missing required parameters for member removal');
        showAlert('Missing required parameters for member removal', 'error');
        return;
    }
    
    // Show loading state on the member card and button
    if (memberCard) {
        memberCard.style.opacity = '0.7';
        memberCard.style.pointerEvents = 'none';
        
        // Update remove button to show loading state
        const removeBtn = memberCard.querySelector('.admin-remove-member');
        if (removeBtn) {
            removeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            removeBtn.style.background = '#f59e0b';
            removeBtn.disabled = true;
        }
    }
    
    const url = `/chamas-bookeeping/remove-member-from-chama/${memberId}/${chamaId}/`;
    
    // Make AJAX call to remove member
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            showAlert(`${memberName} has been removed from the chama`, 'warning');
            if (memberCard) {
                // Add a "removing" indicator
                const removeBtn = memberCard.querySelector('.admin-remove-member');
                if (removeBtn) {
                    removeBtn.innerHTML = '<i class="fas fa-check"></i>';
                    removeBtn.style.background = '#10b981';
                }
                
                // Animate the removal
                memberCard.style.transform = 'scale(0.8)';
                memberCard.style.opacity = '0';
                memberCard.style.filter = 'grayscale(100%)';
                
                setTimeout(() => {
                    memberCard.remove();
                    initializeMembers(); // Refresh pagination
                    
                    // Update member count if displayed
                    const memberCountElements = document.querySelectorAll('.admin-members-title');
                    memberCountElements.forEach(el => {
                        const currentText = el.textContent;
                        const match = currentText.match(/Members \((\d+)\)/);
                        if (match) {
                            const newCount = parseInt(match[1]) - 1;
                            el.textContent = currentText.replace(/\(\d+\)/, `(${newCount})`);
                        }
                    });
                }, 300);
            }
        } else {
            throw new Error(data.message || 'Failed to remove member');
        }
    })
    .catch(error => {
        console.error(`Failed to remove member ${memberName}:`, error);
        showAlert(`Failed to remove ${memberName}: ${error.message}`, 'error');
        
        // Restore member card state
        if (memberCard) {
            memberCard.style.opacity = '1';
            memberCard.style.pointerEvents = 'auto';
            memberCard.style.transform = 'scale(1)';
            memberCard.style.filter = 'none';
            
            // Restore remove button
            const removeBtn = memberCard.querySelector('.admin-remove-member');
            if (removeBtn) {
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.style.background = 'var(--brand-error)';
            }
        }
    });
}

function showAlert(message, type) {
    const alertsContainer = document.getElementById('admin-alerts-container');
    const alertId = 'alert-' + Date.now();
    
    const alertHTML = `
        <div id="${alertId}" class="admin-alert admin-alert-${type}" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i>
            ${message}
            <button onclick="closeAlert('${alertId}')" style="float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer;">&times;</button>
        </div>
    `;
    
    alertsContainer.insertAdjacentHTML('beforeend', alertHTML);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        closeAlert(alertId);
    }, 5000);
}

function closeAlert(alertId) {
    const alert = document.getElementById(alertId);
    if (alert) {
        alert.style.opacity = '0';
        alert.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            alert.remove();
        }, 300);
    }
}

function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token not found');
        return '';
    }
    return csrfToken.value;
}

function formatCurrency(amount) {
    // Format number with commas and handle null/undefined
    if (!amount && amount !== 0) return '0';
    return parseFloat(amount).toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    });
}

function getDefaultAvatar() {
    return "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNGM0Y0RjYiLz4KPGNpcmNsZSBjeD0iMzAiIGN5PSIyMiIgcj0iMTAiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTEwIDUwQzEwIDQwLjMzNTkgMTcuMTYzNCAzMi41IDI2IDMyLjVIMzRDNDIuODM2NiAzMi41IDUwIDQwLjMzNTkgNTAgNTBWNTBIMTBWNTBaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=";
}







// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeMembers();
});
</script>
{% endblock %}