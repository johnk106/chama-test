{% extends 'subscriptions/base_pricing.html' %}
{% load static %}
{% block title %}Payment Invoice{% endblock %}

{% block content %}
    <!-- CSS to hide the Back to Dashboard link when printing -->
<style>
    @media print {
        .no-print {
            display: none;
        }
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md overflow-hidden p-8">
    <!-- Header: M-PESA Logo and Invoice Title -->
    <!-- Payment Success Message -->
    <h3 class="text-lg font-semibold text-green-700 mb-4 no-print">Payment Successful!</h3>
    <p class="mb-8 no-print">Thank you for your payment with M-PESA. Below are your payment details:</p>
    <div class="flex justify-between items-center mb-8">
        <img src="{% static 'images/offcanvas_logo.png' %}" alt="Chamaspace Logo" class="h-12">
        <h2 class="text-2xl font-semibold text-gray-800">Invoice</h2>
    </div>

    <!-- Payment Details -->
    <div class="border-t border-b border-gray-300 py-4 mb-8">
        <div class="flex justify-between">
            <span class="font-medium">Total Amount Paid:</span>
            <span class="text-xl font-bold text-green-600">KES {{ payment_details.amount }}</span>
        </div>
        <div class="flex justify-between mt-2">
            <span>Phone Number:</span>
            <span>+{{ payment_details.phone_number }}</span>
        </div>
    </div>

    <!-- Transaction Information -->
    <div class="bg-gray-50 rounded-lg p-4 mb-8">
        <div class="flex justify-between">
            <span>Date:</span>
            <span>{{ payment_details.transaction_date }}</span>
        </div>
        <div class="flex justify-between mt-2">
            <span>Receipt No:</span>
            <span>{{ payment_details.mpesa_receipt_number }}</span>
        </div>
        <div class="flex justify-between mt-2">
            <span>Payment Status:</span>
            <span>{% if payment_details.payment_status == "SUCCESS" %}PAID{% endif %}</span>
        </div>
    <div class="flex justify-between mt-2">
            <span>Chama:</span>
            <span>{{ payment_details.chama_subscription.chama.name }}</span>
        </div>
        <div class="flex justify-between mt-2">
            <span>Plan:</span>
            <span>{{ payment_details.chama_subscription.plan.name }}</span>
        </div>
        <div class="flex justify-between mt-2">
            <span>Expire at:</span>
            <span>{{ payment_details.chama_subscription.end_date }}</span>
        </div>
    </div>

    <!-- Back to Dashboard and Download Button -->
    <div class="flex justify-between items-center">
        <a href="{% url 'chamas:chama-dashboard' chama_id %}" class="text-green-600 no-print hover:underline">Back to Dashboard</a>
        <button id="download" class="bg-green-600 text-white px-4 py-2 no-print rounded-lg hover:bg-green-700">Download Invoice</button>
    </div>
</div>

<!-- Add JavaScript for downloading the invoice -->
<!--?<script>-->
<!--?    document.getElementById('download').addEventListener('click', function() {-->
<!--?        window.print();  // This will trigger the browser's print dialog which you can use to download as PDF-->
<!--?    });-->
<!--?</script>-->
<script>
    document.getElementById('download').addEventListener('click', function() {
        // Get elements with the 'no-print' class
        var noPrintElements = document.querySelectorAll('.no-print');

        // Hide the elements with 'no-print' class
        noPrintElements.forEach(function(element) {
            element.style.display = 'none';
        });

        // Generate the PDF
        var element = document.body;  // You can specify a particular element if needed
        var fileName="invoice_{{ payment_details.mpesa_receipt_number }}.pdf";
        html2pdf().from(element).save(fileName).then(function() {
            // Restore the 'no-print' elements after PDF generation
            noPrintElements.forEach(function(element) {
                element.style.display = '';
            });
        });
    });
</script>

{% endblock %}
