{% extends 'chamas/base.html' %}
{% load static humanize %}

{% block head %}
<title>Bot Records</title>
<link rel="stylesheet" href="{% static 'chamas/contribution.css' %}">
{% endblock %}

{% block body %}
<div class="text-capitalize">
    <div class="row contribution-details">
        <h4 class="sect-title">Bot Records</h4>
        <!-- Button group to switch tables -->
        <div class="btn-group mb-3" role="group" aria-label="Record types">
            <button type="button" class="btn" id="btn-contributions" style="background-color:#2191a5; color:white;">Contributions</button>
            <button type="button" class="btn" id="btn-fines" style="background-color:#2191a5; color:white;">Fines</button>
            <button type="button" class="btn" id="btn-loans" style="background-color:#2191a5; color:white;">Loans</button>
        </div>

        <!-- Contributions Table -->
        <div class="table-responsive" id="table-contributions">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Member</th>
                        <th>Contribution Name</th>
                        <th>Amount</th>
                        <th class="admin">Options</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contribution in contributions %}
                    <tr>
                        <td>{{ contribution.date_created }}</td>
                        <td>{{ contribution.submitted_member }}</td>
                        <td>{{ contribution.retrieved_contribution.name }}</td>
                        <td>Ksh {{ contribution.amount_paid | intcomma }}</td>
                        <td class="admin">
                            <button class="btn btn-sm" style="background-color:#2191a5; color:white;" 
                                    data-bs-toggle="modal" data-bs-target="#modal-contribution" 
                                    data-id="{{ contribution.id }}" data-date="{{ contribution.date_created }}" 
                                    data-member="{{ contribution.submitted_member }}" 
                                    data-name="{{ contribution.retrieved_contribution.name }}" 
                                    data-amount="{{ contribution.amount_paid }}">
                              View
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Fines Table -->
        <div class="table-responsive d-none" id="table-fines">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Member</th>
                        <th>Fine Type</th>
                        <th>Amount Paid</th>
                        <th>Balance</th>
                        <th class="admin">Options</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fine in fines %}
                    <tr>
                        <td>{{ fine.date_created }}</td>
                        <td>{{ fine.member }}</td>
                        <td>{{ fine.edited_fine.fine_type.name }}</td>
                        <td>Ksh {{ fine.amount_paid | intcomma }}</td>
                        <td>Ksh {{ fine.edited_fine.fine_balance | intcomma }}</td>
                        <td class="admin">
                            <button class="btn btn-sm" style="background-color:#2191a5; color:white;" 
                                    data-bs-toggle="modal" data-bs-target="#modal-fine" 
                                    data-id="{{ fine.id }}" data-date="{{ fine.date_created }}" 
                                    data-member="{{ fine.member }}" 
                                    data-type="{{ fine.edited_fine.fine_type.name }}" 
                                    data-paid="{{ fine.amount_paid }}" 
                                    data-balance="{{ fine.edited_fine.fine_balance }}">
                              View
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Loans Table -->
        <div class="table-responsive d-none" id="table-loans">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Member</th>
                        <th>Loan Type</th>
                        <th>Amount Paid</th>
                        <th>Balance</th>
                        <th class="admin">Options</th>
                    </tr>
                </thead>
                <tbody>
                    {% for loan in loans %}
                    <tr>
                        <td>{{ loan.date_created }}</td>
                        <td>{{ loan.member }}</td>
                        <td>{{ loan.updated_loan.type.name }}</td>
                        <td>Ksh {{ loan.amount_paid | intcomma }}</td>
                        <td>Ksh {{ loan.updated_loan.balance | intcomma }}</td>
                        <td class="admin">
                            <button class="btn btn-sm" style="background-color:#2191a5; color:white;" 
                                    data-bs-toggle="modal" data-bs-target="#modal-loan" 
                                    data-id="{{ loan.id }}" data-date="{{ loan.date_created }}" 
                                    data-member="{{ loan.member }}" 
                                    data-type="{{ loan.updated_loan.type.name }}" 
                                    data-paid="{{ loan.amount_paid }}" 
                                    data-balance="{{ loan.updated_loan.balance }}">
                              View
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<!-- Modals -->
<!-- Contribution Modal -->
<div class="modal fade" id="modal-contribution" tabindex="-1" aria-labelledby="modalContributionLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="form-contribution">
      <div class="modal-header">
        <h5 class="modal-title" id="modalContributionLabel">Contribution Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Date</label>
          <input type="text" class="form-control" id="contrib-date" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Member</label>
          <input type="text" class="form-control" id="contrib-member" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Contribution Name</label>
          <input type="text" class="form-control" id="contrib-name" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Amount Paid</label>
          <input type="number" class="form-control" id="contrib-amount">
        </div>
        <input type="hidden" id="contrib-id">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn" style="background-color:#2191a5; color:white;">Save changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Fine Modal -->
<div class="modal fade" id="modal-fine" tabindex="-1" aria-labelledby="modalFineLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="form-fine">
      <div class="modal-header">
        <h5 class="modal-title" id="modalFineLabel">Fine Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Date</label>
          <input type="text" class="form-control" id="fine-date" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Member</label>
          <input type="text" class="form-control" id="fine-member" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Fine Type</label>
          <input type="text" class="form-control" id="fine-type" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Amount Paid</label>
          <input type="number" class="form-control" id="fine-paid">
        </div>
        <div class="mb-3">
          <label class="form-label">Balance</label>
          <input type="number" class="form-control" id="fine-balance">
        </div>
        <input type="hidden" id="fine-id">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn" style="background-color:#2191a5; color:white;">Save changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Loan Modal -->
<div class="modal fade" id="modal-loan" tabindex="-1" aria-labelledby="modalLoanLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="form-loan">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLoanLabel">Loan Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Date</label>
          <input type="text" class="form-control" id="loan-date" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Member</label>
          <input type="text" class="form-control" id="loan-member" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Loan Type</label>
          <input type="text" class="form-control" id="loan-type" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Amount Paid</label>
          <input type="number" class="form-control" id="loan-paid">
        </div>
        <div class="mb-3">
          <label class="form-label">Balance</label>
          <input type="number" class="form-control" id="loan-balance">
        </div>
        <input type="hidden" id="loan-id">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn" style="background-color:#2191a5; color:white;">Save changes</button>
      </div>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
$(document).ready(function() {
    function showTable(type) {
        $('#table-contributions, #table-fines, #table-loans').addClass('d-none');
        $('#btn-contributions, #btn-fines, #btn-loans').css({'opacity':'0.6'});
        $('#table-' + type).removeClass('d-none');
        $('#btn-' + type).css({'opacity':'1'});
    }

    $('#btn-contributions').click(() => showTable('contributions'));
    $('#btn-fines').click(() => showTable('fines'));
    $('#btn-loans').click(() => showTable('loans'));
    showTable('contributions');

    function populateModal(modalId, dataMap) {
        const modal = $(modalId);
        for (const key in dataMap) {
            modal.find('#' + key).val(dataMap[key]);
        }
    }

    $('#modal-contribution').on('show.bs.modal', function(event) {
        const btn = $(event.relatedTarget);
        populateModal('#modal-contribution', {
            'contrib-id': btn.data('id'),
            'contrib-date': btn.data('date'),
            'contrib-member': btn.data('member'),
            'contrib-name': btn.data('name'),
            'contrib-amount': btn.data('amount')
        });
    });

    $('#modal-fine').on('show.bs.modal', function(event) {
        const btn = $(event.relatedTarget);
        populateModal('#modal-fine', {
            'fine-id': btn.data('id'),
            'fine-date': btn.data('date'),
            'fine-member': btn.data('member'),
            'fine-type': btn.data('type'),
            'fine-paid': btn.data('paid'),
            'fine-balance': btn.data('balance')
        });
    });

    $('#modal-loan').on('show.bs.modal', function(event) {
        const btn = $(event.relatedTarget);
        populateModal('#modal-loan', {
            'loan-id': btn.data('id'),
            'loan-date': btn.data('date'),
            'loan-member': btn.data('member'),
            'loan-type': btn.data('type'),
            'loan-paid': btn.data('paid'),
            'loan-balance': btn.data('balance')
        });
    });

    // Submit placeholders
    $('#form-contribution').submit(e => { e.preventDefault(); alert('Contribution updated'); });
    $('#form-fine').submit(e => { e.preventDefault(); alert('Fine updated'); });
    $('#form-loan').submit(e => { e.preventDefault(); alert('Loan updated'); });
});
</script>
{% endblock %}
